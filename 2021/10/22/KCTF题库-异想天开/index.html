<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>KCTF题库：异想天开 | cataLoc's Blog</title><meta name="description" content="KCTF题库：异想天开"><meta name="keywords" content="CTF,Windows逆向"><meta name="author" content="cataLoc"><meta name="copyright" content="cataLoc"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="KCTF题库：异想天开"><meta name="twitter:description" content="KCTF题库：异想天开"><meta name="twitter:image" content="https://gitee.com/cataloc/blog/raw/master/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/cover0x4B.png"><meta property="og:type" content="article"><meta property="og:title" content="KCTF题库：异想天开"><meta property="og:url" content="http://cata1oc.github.io/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/"><meta property="og:site_name" content="cataLoc's Blog"><meta property="og:description" content="KCTF题库：异想天开"><meta property="og:image" content="https://gitee.com/cataloc/blog/raw/master/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/cover0x4B.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'true'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://cata1oc.github.io/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/"><link rel="prev" title="初探GOT与PLT" href="http://cata1oc.github.io/2021/10/31/%E5%88%9D%E6%8E%A2GOT%E4%B8%8EPLT/"><link rel="next" title="《Linux内核源代码情景分析》笔记" href="http://cata1oc.github.io/2021/07/02/Linux%E5%86%85%E6%A0%B8%E6%BA%90%E4%BB%A3%E7%A0%81%E6%83%85%E6%99%AF%E5%88%86%E6%9E%90%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">cataLoc's Blog</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/Substitute.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">130</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">11</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">Catalog</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#前言"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">前言</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#踩坑流程"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">踩坑流程</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#找入口点"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">找入口点</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#找算法入口"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">找算法入口</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#解法"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">解法</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#总结"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">总结</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#踩坑流程"><span class="toc-number">2.</span> <span class="toc-text">踩坑流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#找入口点"><span class="toc-number">2.1.</span> <span class="toc-text">找入口点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#找算法入口"><span class="toc-number">2.2.</span> <span class="toc-text">找算法入口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解法"><span class="toc-number">3.</span> <span class="toc-text">解法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://gitee.com/cataloc/blog/raw/master/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/cover0x4B.png)"><div id="post-info"><div id="post-title"><div class="posttitle">KCTF题库：异想天开</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> Created 2021-10-22<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> Updated 2021-10-23</time><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>Post View:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>原本想着，在博客记录下做的每一道CTF题，懒癌，一直没有行动；但这题就不一样了，自认为还是有一定难度的，有一定启发性的，所以得抓紧记录下来，不然就忘记思路了。这题最初是上周五（2021.10.15）做的，当时没做出来，回家后又和萌萌哒研究了1小时，还是没头绪（这里有个插曲，萌萌哒发现很多时候我不会用工具，并给了一些指点）。就看了高博（他做出来了）给的算法入口点，然后周日简单写了一个wp，周一做了一个通用的注册机，今天（已经周四了。。。）抽点时间来完成这篇博客吧。</p>
<p>之所以这题花费这么多时间，其实是一直没有定位到算法处，早定位到，就早做出来了，算法本身并不难。而这个定位的过程，正是这一道题的难度所在。这里，就来解析一下这道题。</p>
<h2 id="踩坑流程"><a href="#踩坑流程" class="headerlink" title="踩坑流程"></a>踩坑流程</h2><h3 id="找入口点"><a href="#找入口点" class="headerlink" title="找入口点"></a>找入口点</h3><p>找入口点花了我差不多90min，就是这样，我花了整整90min都没有找到入口点，当然，最终花了一整天都没找到算法入口点。就像我在HiSuite.exe中找了几个月，都没找到验证码校验的地方一样。最终，中午前，高博告诉我，入口点为0x401840，他是通过<code>CreateDialogParamA</code>回溯到的（实际上也可以通过<code>SetDlgItemTextA</code>）。下午，<strong>我通过<code>GetWindowTextA</code>也回溯到了<code>sub_401840</code>（通过这个函数回溯，也是导致我踩到巨坑上的一个主要因素）</strong>。这里呢，简单概括一下回溯的过程：</p>
<ol>
<li><p>该CrackMe程序的入口点都是0x400000，这样就不需要在IDA里面Rebase Program Segment，两者在主程序中的地址是一致的。下面开始回溯，在<code>GetWindowTextA</code>下断，点击确定，断下，栈中看到，由地址0x41DC22调用</p>
<a href="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/backtrace_1.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/backtrace_1.png"></a>
</li>
<li><p>IDA中找到0x41DC22，所在函数为DDX_Text，通过交叉引用，发现其在<code>sub_401440</code>中被调用</p>
<a href="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/backtrace_2.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/backtrace_2.png"></a>
</li>
<li><p>进入，<code>sub_401440</code>，交叉引用，发现地址位于.rodata。遂进入OD，在0x401440处下断，重新执行程序，右下角栈中可以看到<code>sub_401440</code>的返回处为0x41A7A5</p>
<a href="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/backtrace_3-1.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/backtrace_3-1.png"></a>

<a href="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/backtrace_3-2.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/backtrace_3-2.png"></a>
</li>
<li><p>找到0x41A7A5，<strong>发现<code>sub_401440</code>是通过寄存器+偏移来寻址并调用的</strong>，此次调用发生在函数<code>sub_41A750</code>中</p>
<a href="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/backtrace_4.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/backtrace_4.png"></a>
</li>
<li><p>再用同样的方法<strong>在OD中回溯</strong>，就可以找到是在函数<code>sub_401840</code>中调用了<code>sub_401750</code></p>
<a href="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/backtrace_5-1.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/backtrace_5-1.png"></a>

<a href="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/backtrace_5-2.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/backtrace_5-2.png"></a>


</li>
</ol>
<h3 id="找算法入口"><a href="#找算法入口" class="headerlink" title="找算法入口"></a>找算法入口</h3><ol>
<li><p>找到<code>sub_401840</code>后，先F5，打算分析算法（当然，算法并不在这）。先定位到<strong>黄色方框</strong>，这里我在经过OD分析后，已经将变量重命名了，显然这里的作用就是<strong>对输入的用户名和注册码做一个长度校验</strong>，若长度不符合，则会将v4的值设置为this+100处的值，然后跳转。一会来看this+100处存的是什么。再往下看，如果能够通过黄色方框的校验，就会来到LABEL_11，这部分<strong>最像算法</strong>的，就是<strong>红框方框</strong>里面的内容了。但显然不是，高博比我提前一个多小时定位到<code>sub_401840</code>，若这里就是获取flag的算法，他早就做出来了。</p>
<a href="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/trap_1.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/trap_1.png"></a>
</li>
<li><p>在OD中断到0x40185E，然后执行一下对<code>sub_41A750</code>的调用，观察堆栈变化，可以看到栈中有了输入的用户名和注册码；并且先前在利用<code>GetWindowTextA</code>进行回溯时也是从这里出来的。因此，可以推测<code>sub_41A750</code>通过调用<code>GetWindowTextA</code>获取到输入的用户名和注册码，再将其放入栈中的某个位置。</p>
<a href="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/trap_2-1.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/trap_2-1.png"></a>

<p>而这个栈中的位置是什么呢？观察下图，先看OD，<code>mov eax, [esi+0x80]</code>，可以获得到“CTFHUB”，正是输入的用户名，结合左边IDA中的伪代码，就可以推出esi即this。这样就可以得出下表中的结论：</p>
<table>
<thead>
<tr>
<th>伪代码</th>
<th>对应的值</th>
</tr>
</thead>
<tbody><tr>
<td>this + 128</td>
<td>输入的用户名</td>
</tr>
<tr>
<td>this + 124</td>
<td>输入的注册码</td>
</tr>
<tr>
<td>this + 120</td>
<td>未注册</td>
</tr>
<tr>
<td>this + 116</td>
<td>注册码不能为空</td>
</tr>
<tr>
<td>this + 112</td>
<td>用户名不能为空</td>
</tr>
<tr>
<td>this + 100</td>
<td>很遗憾！你输入的注册码不正确</td>
</tr>
<tr>
<td>this + 96</td>
<td>恭喜：你已经注册成功。简单吧？</td>
</tr>
<tr>
<td>this + 92</td>
<td>zouzhiyong-zouzhiyong</td>
</tr>
</tbody></table>
<p>有了这张表格，就能更容易看明白左图这张IDA的伪代码，在获取了值以后，需要先保证输入用户名的长度大于等于5，且输入注册码的长度大于等于19，这样才会执行的LABEL_11，即一个<strong>看上去</strong>有着flag算法逻辑的地方。</p>
<a href="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/trap_2-2.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/trap_2-2.png"></a>
</li>
<li><p>这里来看下LABEL_11的逻辑，很显然，<strong>如果存在flag的运算，那肯定就是黄色方框</strong>的部分了。再往后看，<strong>红色方框</strong>有一个校验。<strong>判断字符串Str1的值，与this+92（即字符串zouzhiyong-zouzhiyong）的值是否相等</strong>。如果相等，那v9的值会被设置为this+96，看似这样就能成功了。那再去看Str1的值哪来，如果说黄色方框是进行flag运算的部分，那么它是通过this+92这个字符串进行运算的。但这样问题也就来了，在对该字符串进行如下的一串运算后，再和自身进行比较，若一致，则能成功。显然，这里不可能成功。因为经过黄色方框中的运算，字符串不可能还会是原先的字符串了。我曾在这里卡壳了很久，认为通过计算出一个经过黄色方框中运算，能够得到字符串”zouzhiyong-zouzhiyong“的原始字符串，很显然，我怎么都无法获取到0x7E以上的字符，更何况，这里根本就没有用输入的注册码进行计算，而是用一个内置的字符串进行运算后再与自身比较，所以我被坑了。因此结论很明显了，那就是根本不能进入这个黄色方框的if语句，一旦进来了，那就已经无法通过校验了。</p>
<a href="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/trap_3.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/trap_3.png"></a>
</li>
<li><p>之后就一直在<code>sub_401840</code>中徘徊，进去看了该函数中的所有函数调用，都没有看着像算法实现的地方，始终无法找到计算flag的位置处，甚至一度怀疑是入口点找错了，根本不在<code>sub_401840</code>。后来看了高博给我的flag算法所在的函数，我从此处开始回溯，确实回溯到了<code>sub_401840</code>，也发现了问题所在。</p>
</li>
</ol>
<h2 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h2><ol>
<li><p>真正的问题其实就在<code>sub_401750</code>中，由于我一开始找入口点是通过<code>GetWindowTextA</code>回溯的，也途径了<code>sub_401750</code>。因此就默认<code>sub_401750</code>是一个初始化this成员的函数，但实际上并不仅仅如此。在<code>sub_401750</code>中有一个不确定的点，就是<code>call dword ptr [eax+0x84]</code>这条调用指令，该调用采用了寄存器+偏移的方式寻址，这意味着，如果<code>sub_401750</code>被多次调用，每次执行到这里时，所调用的函数是不确定的。而恰好，这个<code>sub_401750</code>确实有被多次调用，且每次执行到这时调用的函数并不一样，而之前在利用<code>GetWindowTextA</code>进行回溯时，也仅仅从函数<code>sub_401440</code>回溯过来，即下图的第一种情况，也因此，忽略了。而在这里下断，会断下了3次（实际上是4次，但是第1次是在执行<code>sub_401840</code>之前）。这样也就有额外的两个函数需要分析，即<code>sub_401E80</code>和<code>sub_401AB0</code></p>
<a href="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/analyze_1.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/analyze_1.png"></a>
</li>
<li><p>先来看<code>sub_401E80</code>，这里就直接把该函数的各个调用的伪代码贴一下，显然，该函数及其子函数是没有flag算法实现的</p>
<a href="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/analyze_2.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/analyze_2.png"></a>
</li>
<li><p>接着看<code>sub_401AB0</code>，很明显<code>sub_419413</code>的部分并没有flag的算法实现，但是要注意，这里也调用了<code>GetWindowTextA</code>，该API也被多次调用，但是我在回溯时，也只回溯到了第一次调用的时候，因此最终回溯到了<code>sub_401840</code>而不是<code>sub_419413</code>。</p>
<p>再看<code>sub_401AE0</code>，这里面内容很多，实际上flag的算法就在这个函数里面。这里我就不详细分析了，总体难度不大。它分为两步，<strong>首先</strong>是将字符串“zouzhiyong-zouzhiyong”与输入的字符串（本题为”CTFHUB“）进行一个运算，得到一个新的字符串（本题得到新字符串为“yggz-iiiz-uggo-uzoy-zyih”，该字符串可以直接在内存中获得，因而有些人的wp非常简单，但不通用），这个得到字符串的过程还是有点意思的，它有一个ascii求值的循环，前3次求和用的字符串分别是CTFHUB、TTFHU，FTFH，自己找规律哈哈。得到字符串之后，<strong>接下来</strong>会调用<code>sub_401C80</code>实现一个简单的转换，就可以得到最终的flag了，<code>sub_401C80</code>中的运算过程更简单，就不分析了。</p>
<a href="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/analyze_3.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/analyze_3.png"></a>
</li>
<li><p>最后附上写好的一个writeup，唯一限制主要是只能支持长度为6位的用户名，不过感觉差不多了，也不想进一步完善了</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">s1 = <span class="string">'CTFHUB'</span></span><br><span class="line">s2 = <span class="string">'zouzhiyong-zouzhiyong'</span></span><br><span class="line">s3 = []</span><br><span class="line"></span><br><span class="line">str_pos = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> str_pos < <span class="number">5</span>:</span><br><span class="line">	<span class="comment"># 每次循环后，会从s2中获取到4个字符，它们之间需用'-'隔开</span></span><br><span class="line">	<span class="keyword">if</span> str_pos != <span class="number">0</span>:</span><br><span class="line">		s3.append(<span class="string">'-'</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># 这一步计算出此轮循环对s2进行变换时，所需的s1的部分字符串</span></span><br><span class="line">	temp_s = s1[str_pos] + s1[<span class="number">1</span>:<span class="number">6</span>-str_pos]</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># 利用前一步得到s1算出其ascii值的和，用于对s2进行变换，并</span></span><br><span class="line">	<span class="comment"># 将变换后s2存储到s3中</span></span><br><span class="line">	sum_s = <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> temp_s:</span><br><span class="line">		sum_s = sum_s + ord(x)</span><br><span class="line">			</span><br><span class="line">	<span class="keyword">while</span> sum_s < <span class="number">10000</span>:</span><br><span class="line">		sum_s = sum_s * <span class="number">3</span></span><br><span class="line">	</span><br><span class="line">	sum_s = sum_s // <span class="number">3</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span> sum_s != <span class="number">0</span>:</span><br><span class="line">		i = sum_s % <span class="number">10</span></span><br><span class="line">		sum_s = (sum_s - sum_s%<span class="number">10</span>) // <span class="number">10</span></span><br><span class="line">		s3.append(s2[i])</span><br><span class="line">	</span><br><span class="line">	str_pos = str_pos + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">s3 = <span class="string">''</span>.join(s3)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 利用s3计算出最后的flag</span></span><br><span class="line">res = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> s3:</span><br><span class="line">	<span class="keyword">if</span> ord(x) ==  <span class="number">45</span>:</span><br><span class="line">		res.append(x)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		temp = ord(x) - ord(x)%<span class="number">5</span> - <span class="number">20</span> - <span class="number">12</span> - ord(x)%<span class="number">2</span></span><br><span class="line">		res.append(chr(temp))</span><br><span class="line"></span><br><span class="line">print(<span class="string">''</span>.join(res))</span><br></pre></td></tr></tbody></table></figure></div>

</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>猜测可能调用的API并下断，来回溯到函数的入口点是一个值得采取的手段。直接通过winMain去跟，可能很难跟到。用API进行回溯更容易找到某些逻辑的执行处，而通过对堆中数据下内存断点进行回溯则容易死在框架里。</li>
<li>多利用工具，例如IDA伪代码中的Tab键，或者Synchronize with -> IDA-View，可以将伪代码和汇编联系起来（感谢萌萌哒的指导）。以及最近认识到的OD中的插件OllyDump（Dump内存），SharpOD（过Vmp自带的反调试）</li>
<li>进行回溯时，需要了解某个函数的所有交叉调用关系，这点在IDA中用X快捷键可以看的更清晰。而在OD中，从某个API的回溯，往往只能看到某一次调用的过程，从而容易忽略该API在其它地方可能也被调用。</li>
</ol>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">cataLoc</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://cata1oc.github.io/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/">http://cata1oc.github.io/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF    </a><a class="post-meta__tags" href="/tags/Windows%E9%80%86%E5%90%91/">Windows逆向    </a></div><div class="post_share"><div class="social-share" data-image="https://gitee.com/cataloc/blog/raw/master/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/cover0x4B.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2021/10/31/%E5%88%9D%E6%8E%A2GOT%E4%B8%8EPLT/"><img class="prev_cover lazyload" data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2021/10/31/%E5%88%9D%E6%8E%A2GOT%E4%B8%8EPLT/cover0x4C.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Previous Post</div><div class="prev_info"><span>初探GOT与PLT</span></div></a></div><div class="next-post pull_right"><a href="/2021/07/02/Linux%E5%86%85%E6%A0%B8%E6%BA%90%E4%BB%A3%E7%A0%81%E6%83%85%E6%99%AF%E5%88%86%E6%9E%90%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"><img class="next_cover lazyload" data-src="https://gitee.com/cataloc/blog/raw/master/2021/07/02/Linux%E5%86%85%E6%A0%B8%E6%BA%90%E4%BB%A3%E7%A0%81%E6%83%85%E6%99%AF%E5%88%86%E6%9E%90%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/cover0x4A.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>《Linux内核源代码情景分析》笔记</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> Recommend</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/03/12/一次简单的Hook-下/" title="一次简单的Hook（下）"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-12</div><div class="relatedPosts_title">一次简单的Hook（下）</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/10/一次简单的Hook-上/" title="一次简单的Hook（上）"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-10</div><div class="relatedPosts_title">一次简单的Hook（上）</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/03/分析SwapContext/" title="分析SwapContext"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-03</div><div class="relatedPosts_title">分析SwapContext</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/21/逆向分析MmIsAddressValid/" title="逆向分析MmIsAddressValid(10-10-12)"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-21</div><div class="relatedPosts_title">逆向分析MmIsAddressValid(10-10-12)</div></div></a></div></div><div class="clear_both"></div></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By cataLoc</div><div class="framework-info"><span>Driven </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="ribbon_piao" mobile="false" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>