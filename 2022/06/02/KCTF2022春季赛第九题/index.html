<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>KCTF2022春季赛第九题 | cataLoc's Blog</title><meta name="description" content="KCTF2022春季赛第九题"><meta name="keywords" content="CTF,Windows逆向"><meta name="author" content="cataLoc"><meta name="copyright" content="cataLoc"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="KCTF2022春季赛第九题"><meta name="twitter:description" content="KCTF2022春季赛第九题"><meta name="twitter:image" content="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/0x5E.png"><meta property="og:type" content="article"><meta property="og:title" content="KCTF2022春季赛第九题"><meta property="og:url" content="http://cata1oc.github.io/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/"><meta property="og:site_name" content="cataLoc's Blog"><meta property="og:description" content="KCTF2022春季赛第九题"><meta property="og:image" content="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/0x5E.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'true'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://cata1oc.github.io/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/"><link rel="prev" title="堆基础01：ptmalloc2初探" href="http://cata1oc.github.io/2022/06/30/%E5%A0%86%E5%9F%BA%E7%A1%8001-ptmalloc2%E5%88%9D%E6%8E%A2/"><link rel="next" title="KCTF2022春季赛第七题" href="http://cata1oc.github.io/2022/05/24/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%83%E9%A2%98/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">cataLoc's Blog</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/Substitute.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">148</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">14</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">Catalog</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#前言"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">前言</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#准备工作"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">准备工作</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#解题思路"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">解题思路</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#试错"><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">试错</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#换思路"><span class="toc_mobile_items-number">3.2.</span> <span class="toc_mobile_items-text">换思路</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#定位程序输出点"><span class="toc_mobile_items-number">3.2.1.</span> <span class="toc_mobile_items-text">定位程序输出点</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#定位影响程序输出的逻辑（字符串比较）"><span class="toc_mobile_items-number">3.2.2.</span> <span class="toc_mobile_items-text">定位影响程序输出的逻辑（字符串比较）</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#定位字符串的加密逻辑"><span class="toc_mobile_items-number">3.2.3.</span> <span class="toc_mobile_items-text">定位字符串的加密逻辑</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#分析字符串加密逻辑并解密"><span class="toc_mobile_items-number">3.2.4.</span> <span class="toc_mobile_items-text">分析字符串加密逻辑并解密</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#找到其他对输入字符串的变换操作"><span class="toc_mobile_items-number">3.2.5.</span> <span class="toc_mobile_items-text">找到其他对输入字符串的变换操作</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#纠错"><span class="toc_mobile_items-number">3.3.</span> <span class="toc_mobile_items-text">纠错</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#sm4加密算法"><span class="toc_mobile_items-number">3.3.1.</span> <span class="toc_mobile_items-text">sm4加密算法</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#反调试机制"><span class="toc_mobile_items-number">3.3.2.</span> <span class="toc_mobile_items-text">反调试机制</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#更新解密算法"><span class="toc_mobile_items-number">3.3.3.</span> <span class="toc_mobile_items-text">更新解密算法</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#小结"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">小结</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#参考链接"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">参考链接</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作"><span class="toc-number">2.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解题思路"><span class="toc-number">3.</span> <span class="toc-text">解题思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#试错"><span class="toc-number">3.1.</span> <span class="toc-text">试错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#换思路"><span class="toc-number">3.2.</span> <span class="toc-text">换思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#定位程序输出点"><span class="toc-number">3.2.1.</span> <span class="toc-text">定位程序输出点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#定位影响程序输出的逻辑（字符串比较）"><span class="toc-number">3.2.2.</span> <span class="toc-text">定位影响程序输出的逻辑（字符串比较）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#定位字符串的加密逻辑"><span class="toc-number">3.2.3.</span> <span class="toc-text">定位字符串的加密逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分析字符串加密逻辑并解密"><span class="toc-number">3.2.4.</span> <span class="toc-text">分析字符串加密逻辑并解密</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#找到其他对输入字符串的变换操作"><span class="toc-number">3.2.5.</span> <span class="toc-text">找到其他对输入字符串的变换操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#纠错"><span class="toc-number">3.3.</span> <span class="toc-text">纠错</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sm4加密算法"><span class="toc-number">3.3.1.</span> <span class="toc-text">sm4加密算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#反调试机制"><span class="toc-number">3.3.2.</span> <span class="toc-text">反调试机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#更新解密算法"><span class="toc-number">3.3.3.</span> <span class="toc-text">更新解密算法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">4.</span> <span class="toc-text">小结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考链接"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/0x5E.png)"><div id="post-info"><div id="post-title"><div class="posttitle">KCTF2022春季赛第九题</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> Created 2022-06-02<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> Updated 2022-06-04</time><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>Post View:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这是一道和第三题一样，付出了我很多心血的题目。从周六开始，一直没有思路，开始想着就这样放弃了，毕竟只有那四位做出来，但是到了周日晚上，突然打开了思路，趁着题目还有1天时间，决定周一再尝试一次，周一花了一天时间，下班时已经解出Sm4算法，回家后也找到了进行异或的位置，实际上已经分析出了全部的加密算法过程。可惜，最终败在了反调试上，周二早上一上午都没有再更进一步，遗憾没能拿分。但是这次失败，让我学习到了很多，同时也打开了一些思路，也许可以用到未来的做题或者逆向上。因此，这里把本题的做题时的思路、期间遇到的砍、最后遇到的瓶颈以及解决方案都记录一下，这也是逆向经验的一部分。希望最后两道逆向题，可以有所作为，拿到些分。</p>
<p>6月2日将这篇发在了<a href="https://bbs.pediy.com/thread-273130.htm" target="_blank" rel="noopener">看雪</a>（花了2天才写完，5月31日中午这题结束的），同时在晚上更新到了自己的博客。6月3日一觉起来，发现这篇被设置成了精华！！！超级开心！尽管这可能是段老大看我辛苦写了这么多，给的一些激励，但我依旧非常开心，有了极大的动力！现在，此时此刻，也争取，能够在端午假期完成剩下的题目。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>第一步，是令程序禁止地址随机化，这样程序每次从0x400000开始加载，而不是每次开机都会随机选择一个地址。虽然通过对IDA进行Segment的Rebase，也可以使其地址与OD/x32dbg一致（说起来，大佬们都是用x32dbg去做题，高博平时分析也是，看来以后做题时也得切换调试器了），但是用0x400000显然更好，并且也能与家里电脑分析时保持一致。具体手法如下图：</p>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/prepare.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/prepare.png"></a>



<h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><h3 id="试错"><a href="#试错" class="headerlink" title="试错"></a>试错</h3><ol>
<li><p>首先会判断输入的字符串首字符是否为’A’，以及长度是否为32位。</p>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/try_1.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/try_1.png"></a>
</li>
<li><p>如果死在前两处校验，则会打印错误；否则会打印失败</p>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/try_2.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/try_2.png"></a>
</li>
<li><p>寻找触发失败流程的代码块</p>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/try_3.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/try_3.png"></a>

<ul>
<li>这一步的目标是找到，执行后打印出”失败”的函数，往往这个函数，就是对变换后的字符串进行比较的函数（比如<code>strcmp</code>，<code>memcmp</code>），确定字符串比较的位置后，再然后通过交叉引用向上溯源，就可以找到对字符串进行加密或者变换的代码了</li>
<li>首先是字符串识别，发现并没有找到”失败/错误”的字样。然后在<code>main</code>函数中继续往后找，发现在执行完函数<code>sub_403C3B</code>后，就会打印失败。注意<code>sub_403C3B</code>是不能F8步过的，因为有反调试，F8直接就跑飞了，所以在该函数后下一条指令处下断，然后F9</li>
<li>接着进入<code>sub_403C3B</code>，这是一个1000多行的函数，当然后面分析时会遇到一堆平均4000行的函数，甚至上万行无法进行F5查看伪代码的函数。我们用同样的方法定位到了<code>sub_43A44D</code>，该函数同样是不能F8步过，执行后打印失败，并且这又是一个1000多行的函数，这样下去就套娃了，并且会越来越难分析（我确实试图分析了几个，显然是没法达成目的的），因此这条路就走不下去</li>
</ul>
</li>
<li><p>分析别的可疑代码</p>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/try_4.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/try_4.png"></a>

<ul>
<li>然后我对象发现在<code>main</code>函数中的两个校验之前，有一个<code>CreateThread</code>，通常恶意样本就会通过此方式创建线程执行恶意行为。遂跟着她这个思路走了一遍，StartAddress指向的是一个创建socket的函数，它里面又创建了一个线程，指向关闭socket的函数。同样没有什么发现</li>
<li>接下来就是我和大佬之间的差距了，<a href="https://bbs.pediy.com/thread-273087.htm" target="_blank" rel="noopener">mb_mgodlfyn</a>文章中指出，这个关闭socket的函数里有一个<code>sub_49C89D</code>（他是通过<strong>对<code>socket</code>函数进行交叉引用+回溯找到这里的</strong>），该函数里面有一个逻辑是与0x55进行异或。虽然题目说了这里的代码确实是干扰项，但在对输入字符串进行处理时，确实有一个与0x55逐字节进行异或的操作（虽然这里的0x55异或也是干扰项），但如果很早发现这里，对解题是有一定帮助的，只能说大佬还是非常的细，这一点需要我去学习</li>
</ul>
</li>
<li><p>硬件断点寻找触发点</p>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/try_5.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/try_5.png"></a>

<ul>
<li>接下来考虑硬件断点，在main函数的后方，有一处对输入的字符串进行操作，这是能看到的最后一次对输入字符串进行操作的地方，这里会将输入字符串和内置的字符串进行一个拼接，其中开头32字节对应输入字符串的ascii码，在此下硬件访问断点即可</li>
<li>可惜，对该字符串的操作，仅仅只是被复制1次，例如从A处复制一份到B处，所以还得在B处下断，然后发现接下来又会从B处复制一份到C处，这样无线套娃，由于硬件断点只能下4个，内存断点容易不稳定。因此，最后我干脆直接F4的，在发现这个字符串至少被复制了50次后，放弃继续跟踪下去，路又走窄了</li>
<li>以上的尝试，就是从周六放题开始，至周日晚上进行的所有尝试</li>
</ul>
</li>
</ol>
<h3 id="换思路"><a href="#换思路" class="headerlink" title="换思路"></a>换思路</h3><h4 id="定位程序输出点"><a href="#定位程序输出点" class="headerlink" title="定位程序输出点"></a>定位程序输出点</h4><a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_1_1.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_1_1.png"></a>

<ul>
<li>既然不能找到”失败”的字样，决定换个思路，毕竟”错误”的字样是可以找到的，只要输入的字符串长度不为32，或者第一个字符不为’A’，就会打印出”错误”</li>
<li>经过单步验证，输入字符串”1234”（符合首字符不为’A’的情况），会依次调用<code>sub_415B2C</code>、<code>sub_499715</code>、<code>sub_49B4ED</code>这3个函数，其中执行完<code>sub_49B4ED</code>后，可以在eax指向的地址中找到中文字符”错误”，执行完<code>sub_49B4ED</code>后，会在命令行中打印出”错误”</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_1_2.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_1_2.png"></a>

<ul>
<li>回到IDA中分析伪代码，通过观察可以发现，<code>sub_415B2C</code>初始化了一个数组，然后<code>sub_499715</code>通过对数组中特定位置字符进行异或运算，解出”错误”对应的ascii码，然后再通过<code>sub_49B4ED</code>打印出字符</li>
<li>图中两处橙色方框，都是先初始化数组，再进行异或解密，然后打印字符；但是两处初始化数组的函数不同，解密函数也不同，<strong>用于打印字符的函数是相同的</strong>。根据这个特征，我们可以去找<code>sub_49B4ED</code>这个函数的交叉引用，这样也许就可以找到打印”失败”所在的位置了</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_1_3.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_1_3.png"></a>

<ul>
<li>可以看到，在函数<code>sub_46D092</code>中也有三处调用<code>sub_49B4ED</code>的地方。进入其所在汇编附近（这里无法看伪代码，因为函数过长，超过1w行，IDA无法解析，修改解析函数大小后，又遇到了stack frame is too big的问题，查阅资料后扔无法解决，因此只能看汇编），可以看到，在每次调用<code>sub_49B4ED</code>之前，都有2个call，猜测这两个call是分别用来数组初始化与解密得到中文字符用的。</li>
<li>因此只需要<strong>在OD/x32dbg中，Patch一下，直接call到这三处打印字符函数前初始化数组的地方，然后观察命令行中打印的字符。</strong>最后可以得到有两处打印”失败”，一处打印”成功”，在上图中，已经标注出</li>
</ul>
<h4 id="定位影响程序输出的逻辑（字符串比较）"><a href="#定位影响程序输出的逻辑（字符串比较）" class="headerlink" title="定位影响程序输出的逻辑（字符串比较）"></a>定位影响程序输出的逻辑（字符串比较）</h4><a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_2_1.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_2_1.png"></a>

<ul>
<li>在找到”失败/成功”的打印处后，我们就可以向上寻找类似字符串比较的地方。由于这三处打印所在的函数非常长且畸形，无法进行反汇编，大佬都采用<a href="https://github.com/NationalSecurityAgency/ghidra/releases?q=&expanded=true" target="_blank" rel="noopener">Ghidra</a>进行伪代码分析，听说Ghidra对畸形代码的支持较号，但是伪代码的效果就远不如IDA了。</li>
<li>纯看汇编肯定不行，上万行呢！好在IDA支持CFG的形式，这里需要按照上图所示，在选项中对Graph视图进行配置，调整最大结点数，然后就能够以”基本块+边”的方式对汇编进行查看，体验会稍好些</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_2_2.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_2_2.png"></a>

<ul>
<li>先找到<code>loc_47541A</code>这个基本块，这个基本块里会打印出”失败”，我标记为”失败1”是因为，一共有2个失败，说明可能有2次判断，而这里打印”失败”的地址最靠前，说明会受到第一次判断的影响，因此被标记为”失败1”，也就先分析它</li>
<li>由图，可以看到，想要走到<code>loc_47541A</code>这个基本块，需要经过橙色方框框出来的边；如果<strong>不走到这个基本块，有两种思路，一种是走紫色方框框出来的边，另一种是红色方块框出的这条边</strong>。经过简单的验证，可以先排除红色方框的这条边，因为这条边连接着的两个基本块，范围在打印”成功”之外，所以就不在考虑范围内了。接下来考察紫色方框框出的边</li>
<li>这里还有一点需要说明，就是图中左右两侧的边都是直上直下连接的，也就是说左侧是从上到下几乎完全线性的基本块，<strong>不会有边从左侧的基本块连接到右侧的基本块</strong>，右侧也几乎同样如此，所以此时基本可以忽略左侧的基本块，直接看右侧上方的调用链即可</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_2_3.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_2_3.png"></a>

<ul>
<li>在往上查看右侧调用链时，可以发现打印”成功”的基本块，并且是在右侧。我们知道左侧的基本块会走到”失败”，现在我们要找到，导致走向失败或者成功的这个分支点在哪</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_2_4.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_2_4.png"></a>

<ul>
<li>再往上看，就可以找到图中所示的这片代码块了，在这里，我们看到了”失败2”所在的代码块。这里重点关注两个蓝色方框</li>
<li>首先是<strong>上方的蓝色方框</strong>，这里会进行跳转，如果走了红色跳转，就会进入”失败1”，因此需要避免，需要程序走到绿色的分支</li>
<li>其次是<strong>下面的蓝色方框</strong>（位于<code>loc_478405</code>），这里是一个循环，和上方的代码块<code>loc_4783E3</code>是关联的，IDA没有完全分析出，进入OD下断（当然先把前面的分支跳转patch掉，使之可以走到此处的代码块）可以发现，这一块是对输入的字符串进行判断，筛选出小写，即只允许输入 [0-9A-Za-z] 范围内的字符</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_2_5.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_2_5.png"></a>

<ul>
<li>继续往上分析，找到导致跳转的源头，结合OD进行分析，可以得到，这里<strong>对栈中的值进行了比较，若两处的值完全相同，则会进入理想的分支中</strong>。否则会跳转到”失败1”对应的分支</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_2_6.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_2_6.png"></a>

<ul>
<li>通过交叉引用，可以发现，其中进行比较的一个值是写死的，可以直接找到（所以另一个值就是将输入的字符串进行变换得到的了），这里可以先将其记录下</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_2_7.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_2_7.png"></a>

<ul>
<li>这里可以看到，随机输入的字符串，得到的新字符串（暂且称作其为加密字符串），和需要进行比较的结果差距还是很大的。接下来要做的，就是找出字符串是如何经过变换得到加密字符串的</li>
</ul>
<h4 id="定位字符串的加密逻辑"><a href="#定位字符串的加密逻辑" class="headerlink" title="定位字符串的加密逻辑"></a>定位字符串的加密逻辑</h4><a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_3_1.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_3_1.png"></a>

<ul>
<li>我们可以看到在当前函数中是没有其它位置修改了这个值，并且在上一张图中可以看到，在实际情况中，加密字符串位于[ebp+0x1B0]开始的地址处（ecx的值初始为0，每轮加1，用于遍历字符串）。所以接下来，我们就向上回溯，寻找会向地址[ebp+0x1B0]处写入值的函数</li>
<li><strong>这里为什么要找[ebp+0x1B0]？上层调用函数栈不是会下降吗？ebp变了，为啥寻址没变？</strong>其实我也不知道为啥要这样做，我只是找规律，我通过交叉引用找到调用<code>sub_46D092</code>的上层函数时，发现在该函数[ebp+0x1B0]的位置，也已经存储了加密后的字符串（这意味着还需要往上层找），尽管<code>sub_46D092</code>中的ebp和上层函数中的ebp值不一样，但是加密字符串都是存在[ebp+0x1B0]处，所以按照规律就这么找了，这里对这个地址下硬件访问断点也可以</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_3_2.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_3_2.png"></a>

<ul>
<li>然后我们在<code>sub_4631E9</code>中找到了，arg_1A8对应的刚好是0x1B0。这是<code>sub_46D092</code>上层函数的上层函数</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_3_3.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_3_3.png"></a>

<ul>
<li>接下来，通过交叉引用，可以找到一个函数<code>sub_49AF99</code>，它将[ebp+0x1B0]这个地址作为参数传了进去</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_3_4.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_3_4.png"></a>

<ul>
<li>单步调试一下，也可以发现，执行<code>sub_49AF99</code>前，会传入一个空缓冲区，执行后就填充了加密后的字符串，这下可以断定，这里的<code>sub_49AF99</code>就是对字符串进行加密的地方。接下来就可以针对<code>sub_49AF99</code>这个函数进行分析</li>
</ul>
<h4 id="分析字符串加密逻辑并解密"><a href="#分析字符串加密逻辑并解密" class="headerlink" title="分析字符串加密逻辑并解密"></a>分析字符串加密逻辑并解密</h4><a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_4_1.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_4_1.png"></a>

<ul>
<li>这部分主要就是逆向基本功，结合IDA和OD进行分析，然后还原加密的算法。因此这里仅作一些简单的描述。前面讨论的如何定位到这个算法的位置才是关键</li>
<li>首先<code>sub_49AF99</code>有5个参数，a1是用于给字符串加密的密钥（我一开始分析时，没意识到这个是密钥），Source是经过一次变换后得到的字符串，Size是经过变换后字符串的大小，a4存放经过加密后的字符串</li>
<li>这里的<code>unkown_libname_3</code>其实就是malloc，IDA没解析出来，然后依次调用<code>malloc</code>、<code>memset</code>、<code>strcpy</code>，将已经经过一次变换后的字符串，复制到一块新初始化的<strong>大小为0x20字节</strong>的堆空间中。这里需要补充一点，在单步调试时会发现，此处已经经过变换的字符串其实只有0x10字节，并且<code>strcpy</code>在复制字符串时遇到0x00就会截断。因此也只复制了0x10字节到这个大小为0x20字节的堆块中。那为什么要申请0x20字节的空间呢？咱接着分析</li>
<li><code>sub_49D068</code>实际上就是memset，初始化一块栈空间，然后<strong>调用<code>sub_49D38F</code>，通过密钥a1，生成一个box，实际上就是进行了密钥扩展</strong>。我测试了不同的输入字符串，然后在此处下断，发现每次生成的box值是不变的，因此在分析时就直接拿来用了</li>
<li>接下来调用<code>sub_49D025</code>进行加密，这里有4个参数，v10为刚刚初始化的box，v5是存放字符串的堆块的大小（这里是0x20，前0x10存着经过变换的字符串，后0x10字节是0），v9是堆块首地址，指向字符串第一个字符，a4用于存放加密后的字符串</li>
<li>进入<code>sub_49D025</code>，这有一个循环，v7计算出的值为2（因为length的值为0x20），所以会循环两次，分别去调用<code>sub_49D07F</code>去计算加密字符串的结果，一次加密16个字节。所以<code>sub_49D025</code>实现的是多块加密，<code>sub_D07F</code>实现的是单个块加密。这里也可以看出来，输入的字符串经过变换后只剩下0x10字节，但加密时仍然会分块加密，一共加密0x20个字节，并且第二次加密的0x10字节所使用的字符串全为0</li>
<li>进入<code>sub_49D07F</code>，就是加密算法了，这部分可以先将功能逆出来，然后再写出解密算法，还原的代码如下：</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加密算法</span></span><br><span class="line"></span><br><span class="line">s1 = <span class="string">'A1234567123456781234567812345678'</span></span><br><span class="line">s2 = <span class="string">'00000000000000000000000000000000'</span></span><br><span class="line"></span><br><span class="line">byte_7EC3E8 = [</span><br><span class="line"><span class="number">0xD6</span>, <span class="number">0x90</span>, <span class="number">0xE9</span>, <span class="number">0xFE</span>, <span class="number">0xCC</span>, <span class="number">0xE1</span>, <span class="number">0x3D</span>, <span class="number">0xB7</span>,</span><br><span class="line"><span class="number">0x16</span>, <span class="number">0xB6</span>, <span class="number">0x14</span>, <span class="number">0xC2</span>, <span class="number">0x28</span>, <span class="number">0xFB</span>, <span class="number">0x2C</span>, <span class="number">0x05</span>, <span class="number">0x2B</span>, <span class="number">0x67</span>, <span class="number">0x9A</span>, <span class="number">0x76</span>, <span class="number">0x2A</span>, <span class="number">0xBE</span>, <span class="number">0x04</span>, <span class="number">0xC3</span>,</span><br><span class="line"><span class="number">0xAA</span>, <span class="number">0x44</span>, <span class="number">0x13</span>, <span class="number">0x26</span>, <span class="number">0x49</span>, <span class="number">0x86</span>, <span class="number">0x06</span>, <span class="number">0x99</span>, <span class="number">0x9C</span>, <span class="number">0x42</span>, <span class="number">0x50</span>, <span class="number">0xF4</span>, <span class="number">0x91</span>, <span class="number">0xEF</span>, <span class="number">0x98</span>, <span class="number">0x7A</span>,</span><br><span class="line"><span class="number">0x33</span>, <span class="number">0x54</span>, <span class="number">0x0B</span>, <span class="number">0x43</span>, <span class="number">0xED</span>, <span class="number">0xCF</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>, <span class="number">0xE4</span>, <span class="number">0xB3</span>, <span class="number">0x1C</span>, <span class="number">0xA9</span>, <span class="number">0xC9</span>, <span class="number">0x08</span>, <span class="number">0xE8</span>, <span class="number">0x95</span>,</span><br><span class="line"><span class="number">0x80</span>, <span class="number">0xDF</span>, <span class="number">0x94</span>, <span class="number">0xFA</span>, <span class="number">0x75</span>, <span class="number">0x8F</span>, <span class="number">0x3F</span>, <span class="number">0xA6</span>, <span class="number">0x47</span>, <span class="number">0x07</span>, <span class="number">0xA7</span>, <span class="number">0xFC</span>, <span class="number">0xF3</span>, <span class="number">0x73</span>, <span class="number">0x17</span>, <span class="number">0xBA</span>,</span><br><span class="line"><span class="number">0x83</span>, <span class="number">0x59</span>, <span class="number">0x3C</span>, <span class="number">0x19</span>, <span class="number">0xE6</span>, <span class="number">0x85</span>, <span class="number">0x4F</span>, <span class="number">0xA8</span>, <span class="number">0x68</span>, <span class="number">0x6B</span>, <span class="number">0x81</span>, <span class="number">0xB2</span>, <span class="number">0x71</span>, <span class="number">0x64</span>, <span class="number">0xDA</span>, <span class="number">0x8B</span>,</span><br><span class="line"><span class="number">0xF8</span>, <span class="number">0xEB</span>, <span class="number">0x0F</span>, <span class="number">0x4B</span>, <span class="number">0x70</span>, <span class="number">0x56</span>, <span class="number">0x9D</span>, <span class="number">0x35</span>, <span class="number">0x1E</span>, <span class="number">0x24</span>, <span class="number">0x0E</span>, <span class="number">0x5E</span>, <span class="number">0x63</span>, <span class="number">0x58</span>, <span class="number">0xD1</span>, <span class="number">0xA2</span>,</span><br><span class="line"><span class="number">0x25</span>, <span class="number">0x22</span>, <span class="number">0x7C</span>, <span class="number">0x3B</span>, <span class="number">0x01</span>, <span class="number">0x21</span>, <span class="number">0x78</span>, <span class="number">0x87</span>, <span class="number">0xD4</span>, <span class="number">0x00</span>, <span class="number">0x46</span>, <span class="number">0x57</span>, <span class="number">0x9F</span>, <span class="number">0xD3</span>, <span class="number">0x27</span>, <span class="number">0x52</span>,</span><br><span class="line"><span class="number">0x4C</span>, <span class="number">0x36</span>, <span class="number">0x02</span>, <span class="number">0xE7</span>, <span class="number">0xA0</span>, <span class="number">0xC4</span>, <span class="number">0xC8</span>, <span class="number">0x9E</span>, <span class="number">0xEA</span>, <span class="number">0xBF</span>, <span class="number">0x8A</span>, <span class="number">0xD2</span>, <span class="number">0x40</span>, <span class="number">0xC7</span>, <span class="number">0x38</span>, <span class="number">0xB5</span>,</span><br><span class="line"><span class="number">0xA3</span>, <span class="number">0xF7</span>, <span class="number">0xF2</span>, <span class="number">0xCE</span>, <span class="number">0xF9</span>, <span class="number">0x61</span>, <span class="number">0x15</span>, <span class="number">0xA1</span>, <span class="number">0xE0</span>, <span class="number">0xAE</span>, <span class="number">0x5D</span>, <span class="number">0xA4</span>, <span class="number">0x9B</span>, <span class="number">0x34</span>, <span class="number">0x1A</span>, <span class="number">0x55</span>,</span><br><span class="line"><span class="number">0xAD</span>, <span class="number">0x93</span>, <span class="number">0x32</span>, <span class="number">0x30</span>, <span class="number">0xF5</span>, <span class="number">0x8C</span>, <span class="number">0xB1</span>, <span class="number">0xE3</span>, <span class="number">0x1D</span>, <span class="number">0xF6</span>, <span class="number">0xE2</span>, <span class="number">0x2E</span>, <span class="number">0x82</span>, <span class="number">0x66</span>, <span class="number">0xCA</span>, <span class="number">0x60</span>,</span><br><span class="line"><span class="number">0xC0</span>, <span class="number">0x29</span>, <span class="number">0x23</span>, <span class="number">0xAB</span>, <span class="number">0x0D</span>, <span class="number">0x53</span>, <span class="number">0x4E</span>, <span class="number">0x6F</span>, <span class="number">0xD5</span>, <span class="number">0xDB</span>, <span class="number">0x37</span>, <span class="number">0x45</span>, <span class="number">0xDE</span>, <span class="number">0xFD</span>, <span class="number">0x8E</span>, <span class="number">0x2F</span>,</span><br><span class="line"><span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x6A</span>, <span class="number">0x72</span>, <span class="number">0x6D</span>, <span class="number">0x6C</span>, <span class="number">0x5B</span>, <span class="number">0x51</span>, <span class="number">0x8D</span>, <span class="number">0x1B</span>, <span class="number">0xAF</span>, <span class="number">0x92</span>, <span class="number">0xBB</span>, <span class="number">0xDD</span>, <span class="number">0xBC</span>, <span class="number">0x7F</span>,</span><br><span class="line"><span class="number">0x11</span>, <span class="number">0xD9</span>, <span class="number">0x5C</span>, <span class="number">0x41</span>, <span class="number">0x1F</span>, <span class="number">0x10</span>, <span class="number">0x5A</span>, <span class="number">0xD8</span>, <span class="number">0x0A</span>, <span class="number">0xC1</span>, <span class="number">0x31</span>, <span class="number">0x88</span>, <span class="number">0xA5</span>, <span class="number">0xCD</span>, <span class="number">0x7B</span>, <span class="number">0xBD</span>,</span><br><span class="line"><span class="number">0x2D</span>, <span class="number">0x74</span>, <span class="number">0xD0</span>, <span class="number">0x12</span>, <span class="number">0xB8</span>, <span class="number">0xE5</span>, <span class="number">0xB4</span>, <span class="number">0xB0</span>, <span class="number">0x89</span>, <span class="number">0x69</span>, <span class="number">0x97</span>, <span class="number">0x4A</span>, <span class="number">0x0C</span>, <span class="number">0x96</span>, <span class="number">0x77</span>, <span class="number">0x7E</span>,</span><br><span class="line"><span class="number">0x65</span>, <span class="number">0xB9</span>, <span class="number">0xF1</span>, <span class="number">0x09</span>, <span class="number">0xC5</span>, <span class="number">0x6E</span>, <span class="number">0xC6</span>, <span class="number">0x84</span>, <span class="number">0x18</span>, <span class="number">0xF0</span>, <span class="number">0x7D</span>, <span class="number">0xEC</span>, <span class="number">0x3A</span>, <span class="number">0xDC</span>, <span class="number">0x4D</span>, <span class="number">0x20</span>,</span><br><span class="line"><span class="number">0x79</span>, <span class="number">0xEE</span>, <span class="number">0x5F</span>, <span class="number">0x3E</span>, <span class="number">0xD7</span>, <span class="number">0xCB</span>, <span class="number">0x39</span>, <span class="number">0x48</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">box = [</span><br><span class="line"><span class="number">0x8C925023</span>,</span><br><span class="line"><span class="number">0x4BBE4C99</span>,</span><br><span class="line"><span class="number">0x1BF3D26F</span>,</span><br><span class="line"><span class="number">0x1E193BDF</span>,</span><br><span class="line"><span class="number">0x37B81FD9</span>,</span><br><span class="line"><span class="number">0xF82AEB6B</span>,</span><br><span class="line"><span class="number">0x0EB8EA2C</span>,</span><br><span class="line"><span class="number">0x01F7CCC7</span>,</span><br><span class="line"><span class="number">0xC3495601</span>,</span><br><span class="line"><span class="number">0x23FE4548</span>,</span><br><span class="line"><span class="number">0x4A3FC333</span>,</span><br><span class="line"><span class="number">0xCFDF05E8</span>,</span><br><span class="line"><span class="number">0x141FB615</span>,</span><br><span class="line"><span class="number">0x9EF7B415</span>,</span><br><span class="line"><span class="number">0x466E0E37</span>,</span><br><span class="line"><span class="number">0x8BE01DE9</span>,</span><br><span class="line"><span class="number">0xD7566D09</span>,</span><br><span class="line"><span class="number">0xBD20455F</span>,</span><br><span class="line"><span class="number">0xCCC85ED0</span>,</span><br><span class="line"><span class="number">0xC5303952</span>,</span><br><span class="line"><span class="number">0xC847CE90</span>,</span><br><span class="line"><span class="number">0x4ADFA7C6</span>,</span><br><span class="line"><span class="number">0x46803565</span>,</span><br><span class="line"><span class="number">0x1873D9A8</span>,</span><br><span class="line"><span class="number">0xE9AD4459</span>,</span><br><span class="line"><span class="number">0x307C97E3</span>,</span><br><span class="line"><span class="number">0x3ECF9AD7</span>,</span><br><span class="line"><span class="number">0x1C72E515</span>,</span><br><span class="line"><span class="number">0x8F1B291C</span>,</span><br><span class="line"><span class="number">0xFEAB7BE6</span>,</span><br><span class="line"><span class="number">0x677FBEB8</span>,</span><br><span class="line"><span class="number">0xF1EC5D67</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_7CD07F</span><span class="params">(box, s)</span>:</span></span><br><span class="line">	</span><br><span class="line">	res = []</span><br><span class="line">	v15 = []</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">36</span>):</span><br><span class="line">		v15.append(<span class="number">0</span>)</span><br><span class="line">	v4 = int(s[<span class="number">5</span>])</span><br><span class="line">	v15[<span class="number">0</span>] = int(s[<span class="number">3</span>]) | ((int(s[<span class="number">2</span>]) | ((int(s[<span class="number">1</span>]) | (int(s[<span class="number">0</span>]) << <span class="number">8</span>)) << <span class="number">8</span>)) << <span class="number">8</span>)</span><br><span class="line">	v15[<span class="number">1</span>] = int(s[<span class="number">7</span>]) | ((int(s[<span class="number">6</span>]) | ((v4 | (int(s[<span class="number">4</span>]) << <span class="number">8</span>)) << <span class="number">8</span>)) << <span class="number">8</span>);</span><br><span class="line">	v6 = int(s[<span class="number">9</span>])</span><br><span class="line">	v15[<span class="number">2</span>] = int(s[<span class="number">11</span>]) | ((int(s[<span class="number">10</span>]) | ((v6 | (int(s[<span class="number">8</span>]) << <span class="number">8</span>)) << <span class="number">8</span>)) << <span class="number">8</span>)</span><br><span class="line">	v8 = int(s[<span class="number">13</span>])</span><br><span class="line">	v15[<span class="number">3</span>] = int(s[<span class="number">15</span>]) | ((int(s[<span class="number">14</span>]) | ((v8 | (int(s[<span class="number">12</span>]) << <span class="number">8</span>)) << <span class="number">8</span>)) << <span class="number">8</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		print(hex(v15[i]))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x20</span>):</span><br><span class="line">		</span><br><span class="line">		<span class="comment"># assign </span></span><br><span class="line">		ecx = (v15[i+<span class="number">1</span>] ^ v15[i+<span class="number">2</span>] ^ v15[i+<span class="number">3</span>] ^ box[i])</span><br><span class="line">		idx_a = ecx >> <span class="number">0x18</span></span><br><span class="line">		<span class="comment">#print(hex(ecx))</span></span><br><span class="line">		val_a = byte_7EC3E8[idx_a]</span><br><span class="line">		<span class="comment">#print(hex(val_a))</span></span><br><span class="line">		idx_b = (ecx >> <span class="number">0x10</span>) & <span class="number">0x000000FF</span></span><br><span class="line">		val_b = byte_7EC3E8[idx_b]</span><br><span class="line">		val_ab = val_b | (val_a << <span class="number">8</span>)</span><br><span class="line">		<span class="comment">#print(hex(val_b))</span></span><br><span class="line">		<span class="comment">#print(hex(val_ab))</span></span><br><span class="line">		idx_c = (ecx >> <span class="number">0x8</span>) & <span class="number">0x000000FF</span></span><br><span class="line">		val_c = byte_7EC3E8[idx_c]</span><br><span class="line">		val_abc = val_c | (val_ab << <span class="number">8</span>)</span><br><span class="line">		<span class="comment">#print(hex(val_c))</span></span><br><span class="line">		<span class="comment">#print(hex(val_abc))</span></span><br><span class="line">		idx_d = ecx & <span class="number">0x000000FF</span></span><br><span class="line">		val_d = byte_7EC3E8[idx_d]</span><br><span class="line">		val_abcd = val_d | (val_abc << <span class="number">8</span>)</span><br><span class="line">		<span class="comment">#print(hex(val_d))</span></span><br><span class="line">		<span class="comment">#print('val_abcd: ', hex(val_abcd))</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment"># extent	</span></span><br><span class="line">		temp_a = ((val_abcd << <span class="number">18</span>) & <span class="number">0xFFFFFFFF</span>) | (val_abcd >> <span class="number">14</span>) </span><br><span class="line">		temp_b = (val_abcd >> <span class="number">22</span>) | ((val_abcd << <span class="number">10</span>) & <span class="number">0xFFFFFFFF</span>) </span><br><span class="line">		temp_c = ((val_abcd << <span class="number">24</span>) & <span class="number">0xFFFFFFFF</span>) | (val_abcd >> <span class="number">8</span>) </span><br><span class="line">		temp_d = (val_abcd >> <span class="number">30</span>) | ((val_abcd << <span class="number">2</span>) & <span class="number">0xFFFFFFFF</span>) </span><br><span class="line">		<span class="comment">#print(hex(temp_a))</span></span><br><span class="line">		<span class="comment">#print(hex(temp_b))</span></span><br><span class="line">		<span class="comment">#print(hex(temp_c))</span></span><br><span class="line">		<span class="comment">#print(hex(temp_d))</span></span><br><span class="line">		<span class="comment">#print(hex(v15[i]))</span></span><br><span class="line">		v15[i+<span class="number">4</span>] = val_abcd ^ v15[i] ^ temp_a ^ temp_b ^ temp_c ^ temp_d</span><br><span class="line">		res.append(hex(v15[i+<span class="number">4</span>]))</span><br><span class="line">		print(<span class="string">'v15[i+4]: '</span>, hex(v15[i+<span class="number">4</span>]))</span><br><span class="line">		<span class="comment">#break</span></span><br><span class="line">	</span><br><span class="line">	<span class="string">'''	</span></span><br><span class="line"><span class="string">	res = res[::-1][:4]</span></span><br><span class="line"><span class="string">	for x in res:</span></span><br><span class="line"><span class="string">		print(x)</span></span><br><span class="line"><span class="string">	'''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_7CD025</span><span class="params">(box, s1, s2)</span>:</span></span><br><span class="line">    </span><br><span class="line">	v7 = ((<span class="number">0x20</span><span class="number">-1</span>) >> <span class="number">4</span>)+ <span class="number">1</span></span><br><span class="line">	<span class="comment">#for i in range(v7):</span></span><br><span class="line">	sub_7CD07F(box, s1)</span><br><span class="line">	sub_7CD07F(box, s2)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	</span><br><span class="line">	s1 = [<span class="number">0x1A</span>, <span class="number">0x32</span>, <span class="number">0x54</span>, <span class="number">0x76</span>, <span class="number">0x21</span>, <span class="number">0x43</span>, <span class="number">0x65</span>, <span class="number">0x87</span>, <span class="number">0x21</span>, <span class="number">0x43</span>, <span class="number">0x65</span>, <span class="number">0x87</span>, <span class="number">0x21</span>, <span class="number">0x43</span>, <span class="number">0x65</span>, <span class="number">0x87</span>]</span><br><span class="line">	s2 = [<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>]</span><br><span class="line">	sub_7CD025(box, s1, s2)</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>在还原加密算法时，那块比较复杂的加密，实际上是IDA解析的不清晰，直接看汇编会更方便一些。并且那个循环0x20次的算法是自旋的，自旋15次就可以解密，虽然解密时不一定需要自旋，直接逆过去解密也是ok的，具体解密代码如下：</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解密算法</span></span><br><span class="line"><span class="comment"># 解密算法也需要用到box和数组byte_7EC3E8，这里就不重复复制了</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_7CD07F_decode</span><span class="params">(box)</span>:</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">#rst_test = [0x3b0e071, 0x3a904877, 0x45ef484e, 0xb45d2d80]</span></span><br><span class="line">	<span class="comment">#rst = [0x907CBE0E, 0x68F4E360, 0x8D2AA89A, 0xFCFFBE78]</span></span><br><span class="line">	rst = [<span class="number">0x553786E8</span>, <span class="number">0x9B5D05F5</span>, <span class="number">0x5FDC04DD</span>, <span class="number">0xE12A7721</span>]</span><br><span class="line">	rst_v15 = []</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">36</span>):</span><br><span class="line">		rst_v15.append(<span class="number">0</span>)</span><br><span class="line">	rst_v15[<span class="number">35</span>] = rst[<span class="number">0</span>]</span><br><span class="line">	rst_v15[<span class="number">34</span>] = rst[<span class="number">1</span>]</span><br><span class="line">	rst_v15[<span class="number">33</span>] = rst[<span class="number">2</span>]</span><br><span class="line">	rst_v15[<span class="number">32</span>] = rst[<span class="number">3</span>]</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x20</span>):</span><br><span class="line">		</span><br><span class="line">		ecx = (rst_v15[<span class="number">35</span>-i<span class="number">-1</span>] ^ rst_v15[<span class="number">35</span>-i<span class="number">-2</span>] ^ rst_v15[<span class="number">35</span>-i<span class="number">-3</span>] ^ box[<span class="number">35</span>-i<span class="number">-4</span>])</span><br><span class="line">		idx_a = ecx >> <span class="number">0x18</span></span><br><span class="line">		<span class="comment">#print(hex(ecx))</span></span><br><span class="line">		val_a = byte_7EC3E8[idx_a]</span><br><span class="line">		<span class="comment">#print(hex(val_a))</span></span><br><span class="line">		idx_b = (ecx >> <span class="number">0x10</span>) & <span class="number">0x000000FF</span></span><br><span class="line">		val_b = byte_7EC3E8[idx_b]</span><br><span class="line">		val_ab = val_b | (val_a << <span class="number">8</span>)</span><br><span class="line">		<span class="comment">#print(hex(val_b))</span></span><br><span class="line">		<span class="comment">#print(hex(val_ab))</span></span><br><span class="line">		idx_c = (ecx >> <span class="number">0x8</span>) & <span class="number">0x000000FF</span></span><br><span class="line">		val_c = byte_7EC3E8[idx_c]</span><br><span class="line">		val_abc = val_c | (val_ab << <span class="number">8</span>)</span><br><span class="line">		<span class="comment">#print(hex(val_c))</span></span><br><span class="line">		<span class="comment">#print(hex(val_abc))</span></span><br><span class="line">		idx_d = ecx & <span class="number">0x000000FF</span></span><br><span class="line">		val_d = byte_7EC3E8[idx_d]</span><br><span class="line">		val_abcd = val_d | (val_abc << <span class="number">8</span>)	</span><br><span class="line">		<span class="comment">#print('val_abcd: ', hex(val_abcd))		</span></span><br><span class="line">			</span><br><span class="line">		temp_a = ((val_abcd << <span class="number">18</span>) & <span class="number">0xFFFFFFFF</span>) | (val_abcd >> <span class="number">14</span>) </span><br><span class="line">		temp_b = (val_abcd >> <span class="number">22</span>) | ((val_abcd << <span class="number">10</span>) & <span class="number">0xFFFFFFFF</span>) </span><br><span class="line">		temp_c = ((val_abcd << <span class="number">24</span>) & <span class="number">0xFFFFFFFF</span>) | (val_abcd >> <span class="number">8</span>) </span><br><span class="line">		temp_d = (val_abcd >> <span class="number">30</span>) | ((val_abcd << <span class="number">2</span>) & <span class="number">0xFFFFFFFF</span>) </span><br><span class="line">		<span class="comment">#print(hex(temp_a))</span></span><br><span class="line">		<span class="comment">#print(hex(temp_b))</span></span><br><span class="line">		<span class="comment">#print(hex(temp_c))</span></span><br><span class="line">		<span class="comment">#print(hex(temp_d))</span></span><br><span class="line">		<span class="comment">#print(hex(v15[i]))</span></span><br><span class="line">		rst_v15[<span class="number">35</span>-i<span class="number">-4</span>] = val_abcd ^ rst_v15[<span class="number">35</span>-i] ^ temp_a ^ temp_b ^ temp_c ^ temp_d</span><br><span class="line">		<span class="comment">#print('rst_v15[35-i]: ', hex(rst_v15[35-i]))</span></span><br><span class="line">		print(<span class="string">'rst_v15[35-i-4]: '</span>, hex(rst_v15[<span class="number">35</span>-i<span class="number">-4</span>]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	</span><br><span class="line">	sub_7CD07F_decode(box)</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>我们知道，加密字符串有一个比较的值是写死的，所以我们带入加密后的字符串，分别进行解密，可以得到如下的结果，</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_4_2.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_4_2.png"></a>

<ul>
<li>将图中橙色方框按照顺序，以小端方式写入那个已经经过变换后的字符串堆块（在执行<code>sub_49D07F</code>之前，<code>strcpy</code>之后）中，然后F9执行</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_4_3.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_4_3.png"></a>

<ul>
<li>可以发现，这么做，进行手动修改加密前的字符串，是可以执行成功的，也说解密的程序是没有问题的，但是这里还存在两个问题</li>
<li>第一个问题，这里<strong>想要成功执行，意味着在加密前，堆块里必须是如图所示的0x20字节的字符串，然而在起初用任意字符串进行尝试时，这里仅有0x10字节的字符串，后面0x10字节都是0</strong>，经过加密后，与设定的数据无法匹配</li>
<li>另一方面，<strong>这里的数据包含了<code>311E5200</code>，在先前进行<code>strcpy</code>时，遇到0x00就会截断</strong>，因此即使输入的字符串经过变换后，能够达到图中所示的0x20字节的字符串，但是在进行<code>strcpy</code>时也会进行截断，导致最终执行到这一步时，字符串已经不是图中所预测的那样，那么执行仍然是失败。此时，只能将希望寄托于字符串之前经历的次变换，但是，即使经过此变换可以做到将输入的0x10字节字符串转换为上图所示的0x20个字节的字符，仍然解决不了<code>strcpy</code>截断的问题，但，也只能孤注一掷了 </li>
</ul>
<h4 id="找到其他对输入字符串的变换操作"><a href="#找到其他对输入字符串的变换操作" class="headerlink" title="找到其他对输入字符串的变换操作"></a>找到其他对输入字符串的变换操作</h4><a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_5_1.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_5_1.png"></a>

<ul>
<li>找字符串变换逻辑和找字符串加密逻辑一样，从这里可以看到，字符串作为参数传入<code>sub_49AF99</code>时位于[ebp+Source]也就是[ebp+0x2CA]，然后据此通过交叉引用向上找，看看上层函数是否有修改[ebp+0x2CA]的地方</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_5_2.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_5_2.png"></a>

<ul>
<li>不断的往上找，可以发现在函数<code>sub_44BC99</code>中使用到了[ebp+0x2CA]这个栈空间，在该函数的基本块<code>loc_44EBEC</code>中，将输入的字符串与一个写死的全局变量进行了异或运算，可以看到这个全局变量就是”55555555555555555555555555555555”</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_5_3.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_5_3.png"></a>

<ul>
<li>由上图可以看到，当我们输入”AAAAAAAAAAAAAAAA0000000000000000”后，最终被加密的字符串就是和”55555555555555555555555555555555”异或后的结果。所以，依然是没能解决之前<code>strcpy</code>截断的问题，并且经过异或后，也无法解决后16个字节为0的问题</li>
</ul>
<h3 id="纠错"><a href="#纠错" class="headerlink" title="纠错"></a>纠错</h3><p>总感觉就只差一步，但最终还是无能为力，直至题目结束，看了6位大佬的wp，咨询了出题的师傅，才豁然开朗</p>
<h4 id="sm4加密算法"><a href="#sm4加密算法" class="headerlink" title="sm4加密算法"></a>sm4加密算法</h4><a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_6_1.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_6_1.png"></a>

<ul>
<li><p>首先是对字符串进行加密的算法是SM4加密，由于自身的算法意识浅薄，看不出来（第三题的AES也没看出来），这也导致了始终发现不了最后的坑，Findcrypt也只识别出了MD5和Base64</p>
</li>
<li><p>不过还是有一些特征的，在对进行密钥进行扩展的函数里，可以找到4个常量，搜索一下这4个常量就可以发现这是一个SM4的加密算法。这一点在<a href="https://bbs.pediy.com/thread-273087.htm" target="_blank" rel="noopener">mb_mgodlfyn</a>的文章中有提到</p>
</li>
</ul>
<h4 id="反调试机制"><a href="#反调试机制" class="headerlink" title="反调试机制"></a>反调试机制</h4><ul>
<li>这道题涉及到多种反调试手法，这一点在<a href="https://bbs.pediy.com/thread-273093.htm" target="_blank" rel="noopener">深山修行之人</a>在他的文章进行总结，其中一种，就是修改SM4的密钥key</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_7_1.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_7_1.png"></a>

<ul>
<li>在使用调试器的情况下，用于进行函数扩展的密钥如图中橙色方框所示，此时按照<a href="https://bbs.pediy.com/thread-273087.htm" target="_blank" rel="noopener">mb_mgodlfyn</a>大佬的思路patch在这个基本块Patch一个死循环，然后再附加（这样就可以过掉反调试了，或者像<a href="https://bbs.pediy.com/thread-271868.htm" target="_blank" rel="noopener">中午吃什么</a>大佬那样，注入自己的Dll，在算法前后打印出相应的参数值），然后比较一下密钥的值</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_7_2.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_7_2.png"></a>

<ul>
<li>这里OD附加不了Patch的程序，所以用了x32dbg，可以看到，Patch后停下来得到的密钥确实和原先的不一样。或许这就是真实的密钥</li>
</ul>
<h4 id="更新解密算法"><a href="#更新解密算法" class="headerlink" title="更新解密算法"></a>更新解密算法</h4><ul>
<li>有了真实的密钥，我们可以再跑一遍程序，用真实的密钥替换被修改的密钥进行运算，重新计算出box：</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新后的解密算法，这里更改了box的值</span></span><br><span class="line"></span><br><span class="line">byte_7EC3E8 = [</span><br><span class="line"><span class="number">0xD6</span>, <span class="number">0x90</span>, <span class="number">0xE9</span>, <span class="number">0xFE</span>, <span class="number">0xCC</span>, <span class="number">0xE1</span>, <span class="number">0x3D</span>, <span class="number">0xB7</span>,</span><br><span class="line"><span class="number">0x16</span>, <span class="number">0xB6</span>, <span class="number">0x14</span>, <span class="number">0xC2</span>, <span class="number">0x28</span>, <span class="number">0xFB</span>, <span class="number">0x2C</span>, <span class="number">0x05</span>, <span class="number">0x2B</span>, <span class="number">0x67</span>, <span class="number">0x9A</span>, <span class="number">0x76</span>, <span class="number">0x2A</span>, <span class="number">0xBE</span>, <span class="number">0x04</span>, <span class="number">0xC3</span>,</span><br><span class="line"><span class="number">0xAA</span>, <span class="number">0x44</span>, <span class="number">0x13</span>, <span class="number">0x26</span>, <span class="number">0x49</span>, <span class="number">0x86</span>, <span class="number">0x06</span>, <span class="number">0x99</span>, <span class="number">0x9C</span>, <span class="number">0x42</span>, <span class="number">0x50</span>, <span class="number">0xF4</span>, <span class="number">0x91</span>, <span class="number">0xEF</span>, <span class="number">0x98</span>, <span class="number">0x7A</span>,</span><br><span class="line"><span class="number">0x33</span>, <span class="number">0x54</span>, <span class="number">0x0B</span>, <span class="number">0x43</span>, <span class="number">0xED</span>, <span class="number">0xCF</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>, <span class="number">0xE4</span>, <span class="number">0xB3</span>, <span class="number">0x1C</span>, <span class="number">0xA9</span>, <span class="number">0xC9</span>, <span class="number">0x08</span>, <span class="number">0xE8</span>, <span class="number">0x95</span>,</span><br><span class="line"><span class="number">0x80</span>, <span class="number">0xDF</span>, <span class="number">0x94</span>, <span class="number">0xFA</span>, <span class="number">0x75</span>, <span class="number">0x8F</span>, <span class="number">0x3F</span>, <span class="number">0xA6</span>, <span class="number">0x47</span>, <span class="number">0x07</span>, <span class="number">0xA7</span>, <span class="number">0xFC</span>, <span class="number">0xF3</span>, <span class="number">0x73</span>, <span class="number">0x17</span>, <span class="number">0xBA</span>,</span><br><span class="line"><span class="number">0x83</span>, <span class="number">0x59</span>, <span class="number">0x3C</span>, <span class="number">0x19</span>, <span class="number">0xE6</span>, <span class="number">0x85</span>, <span class="number">0x4F</span>, <span class="number">0xA8</span>, <span class="number">0x68</span>, <span class="number">0x6B</span>, <span class="number">0x81</span>, <span class="number">0xB2</span>, <span class="number">0x71</span>, <span class="number">0x64</span>, <span class="number">0xDA</span>, <span class="number">0x8B</span>,</span><br><span class="line"><span class="number">0xF8</span>, <span class="number">0xEB</span>, <span class="number">0x0F</span>, <span class="number">0x4B</span>, <span class="number">0x70</span>, <span class="number">0x56</span>, <span class="number">0x9D</span>, <span class="number">0x35</span>, <span class="number">0x1E</span>, <span class="number">0x24</span>, <span class="number">0x0E</span>, <span class="number">0x5E</span>, <span class="number">0x63</span>, <span class="number">0x58</span>, <span class="number">0xD1</span>, <span class="number">0xA2</span>,</span><br><span class="line"><span class="number">0x25</span>, <span class="number">0x22</span>, <span class="number">0x7C</span>, <span class="number">0x3B</span>, <span class="number">0x01</span>, <span class="number">0x21</span>, <span class="number">0x78</span>, <span class="number">0x87</span>, <span class="number">0xD4</span>, <span class="number">0x00</span>, <span class="number">0x46</span>, <span class="number">0x57</span>, <span class="number">0x9F</span>, <span class="number">0xD3</span>, <span class="number">0x27</span>, <span class="number">0x52</span>,</span><br><span class="line"><span class="number">0x4C</span>, <span class="number">0x36</span>, <span class="number">0x02</span>, <span class="number">0xE7</span>, <span class="number">0xA0</span>, <span class="number">0xC4</span>, <span class="number">0xC8</span>, <span class="number">0x9E</span>, <span class="number">0xEA</span>, <span class="number">0xBF</span>, <span class="number">0x8A</span>, <span class="number">0xD2</span>, <span class="number">0x40</span>, <span class="number">0xC7</span>, <span class="number">0x38</span>, <span class="number">0xB5</span>,</span><br><span class="line"><span class="number">0xA3</span>, <span class="number">0xF7</span>, <span class="number">0xF2</span>, <span class="number">0xCE</span>, <span class="number">0xF9</span>, <span class="number">0x61</span>, <span class="number">0x15</span>, <span class="number">0xA1</span>, <span class="number">0xE0</span>, <span class="number">0xAE</span>, <span class="number">0x5D</span>, <span class="number">0xA4</span>, <span class="number">0x9B</span>, <span class="number">0x34</span>, <span class="number">0x1A</span>, <span class="number">0x55</span>,</span><br><span class="line"><span class="number">0xAD</span>, <span class="number">0x93</span>, <span class="number">0x32</span>, <span class="number">0x30</span>, <span class="number">0xF5</span>, <span class="number">0x8C</span>, <span class="number">0xB1</span>, <span class="number">0xE3</span>, <span class="number">0x1D</span>, <span class="number">0xF6</span>, <span class="number">0xE2</span>, <span class="number">0x2E</span>, <span class="number">0x82</span>, <span class="number">0x66</span>, <span class="number">0xCA</span>, <span class="number">0x60</span>,</span><br><span class="line"><span class="number">0xC0</span>, <span class="number">0x29</span>, <span class="number">0x23</span>, <span class="number">0xAB</span>, <span class="number">0x0D</span>, <span class="number">0x53</span>, <span class="number">0x4E</span>, <span class="number">0x6F</span>, <span class="number">0xD5</span>, <span class="number">0xDB</span>, <span class="number">0x37</span>, <span class="number">0x45</span>, <span class="number">0xDE</span>, <span class="number">0xFD</span>, <span class="number">0x8E</span>, <span class="number">0x2F</span>,</span><br><span class="line"><span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x6A</span>, <span class="number">0x72</span>, <span class="number">0x6D</span>, <span class="number">0x6C</span>, <span class="number">0x5B</span>, <span class="number">0x51</span>, <span class="number">0x8D</span>, <span class="number">0x1B</span>, <span class="number">0xAF</span>, <span class="number">0x92</span>, <span class="number">0xBB</span>, <span class="number">0xDD</span>, <span class="number">0xBC</span>, <span class="number">0x7F</span>,</span><br><span class="line"><span class="number">0x11</span>, <span class="number">0xD9</span>, <span class="number">0x5C</span>, <span class="number">0x41</span>, <span class="number">0x1F</span>, <span class="number">0x10</span>, <span class="number">0x5A</span>, <span class="number">0xD8</span>, <span class="number">0x0A</span>, <span class="number">0xC1</span>, <span class="number">0x31</span>, <span class="number">0x88</span>, <span class="number">0xA5</span>, <span class="number">0xCD</span>, <span class="number">0x7B</span>, <span class="number">0xBD</span>,</span><br><span class="line"><span class="number">0x2D</span>, <span class="number">0x74</span>, <span class="number">0xD0</span>, <span class="number">0x12</span>, <span class="number">0xB8</span>, <span class="number">0xE5</span>, <span class="number">0xB4</span>, <span class="number">0xB0</span>, <span class="number">0x89</span>, <span class="number">0x69</span>, <span class="number">0x97</span>, <span class="number">0x4A</span>, <span class="number">0x0C</span>, <span class="number">0x96</span>, <span class="number">0x77</span>, <span class="number">0x7E</span>,</span><br><span class="line"><span class="number">0x65</span>, <span class="number">0xB9</span>, <span class="number">0xF1</span>, <span class="number">0x09</span>, <span class="number">0xC5</span>, <span class="number">0x6E</span>, <span class="number">0xC6</span>, <span class="number">0x84</span>, <span class="number">0x18</span>, <span class="number">0xF0</span>, <span class="number">0x7D</span>, <span class="number">0xEC</span>, <span class="number">0x3A</span>, <span class="number">0xDC</span>, <span class="number">0x4D</span>, <span class="number">0x20</span>,</span><br><span class="line"><span class="number">0x79</span>, <span class="number">0xEE</span>, <span class="number">0x5F</span>, <span class="number">0x3E</span>, <span class="number">0xD7</span>, <span class="number">0xCB</span>, <span class="number">0x39</span>, <span class="number">0x48</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">box = [</span><br><span class="line"><span class="number">0x93F611A7</span>,</span><br><span class="line"><span class="number">0xEC090F51</span>,</span><br><span class="line"><span class="number">0xFBFD0886</span>,</span><br><span class="line"><span class="number">0xD123490A</span>,</span><br><span class="line"><span class="number">0xDD33EA6E</span>,</span><br><span class="line"><span class="number">0xE3CDC40D</span>,</span><br><span class="line"><span class="number">0x4B525D0B</span>,</span><br><span class="line"><span class="number">0x39B715DE</span>,</span><br><span class="line"><span class="number">0xBBB268BD</span>,</span><br><span class="line"><span class="number">0x51DE36B0</span>,</span><br><span class="line"><span class="number">0xF26E8995</span>,</span><br><span class="line"><span class="number">0x5206F33E</span>,</span><br><span class="line"><span class="number">0x1AF9D875</span>,</span><br><span class="line"><span class="number">0x55527F61</span>,</span><br><span class="line"><span class="number">0x4441E867</span>,</span><br><span class="line"><span class="number">0x6A5D3667</span>,</span><br><span class="line"><span class="number">0x77CCEA36</span>,</span><br><span class="line"><span class="number">0x9B97E731</span>,</span><br><span class="line"><span class="number">0xCDAF291C</span>,</span><br><span class="line"><span class="number">0x6B7EC875</span>,</span><br><span class="line"><span class="number">0xDFA13590</span>,</span><br><span class="line"><span class="number">0xC7522988</span>,</span><br><span class="line"><span class="number">0x02EEE414</span>,</span><br><span class="line"><span class="number">0x8FBAAF5C</span>,</span><br><span class="line"><span class="number">0x0455AF72</span>,</span><br><span class="line"><span class="number">0x3EF8F342</span>,</span><br><span class="line"><span class="number">0x4BB83656</span>,</span><br><span class="line"><span class="number">0x4F2F9131</span>,</span><br><span class="line"><span class="number">0xE386F4D3</span>,</span><br><span class="line"><span class="number">0x15D3F1A5</span>,</span><br><span class="line"><span class="number">0x27AAE313</span>,</span><br><span class="line"><span class="number">0x6523F806</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_7CD07F_decode</span><span class="params">(box)</span>:</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">#rst_test = [0x3b0e071, 0x3a904877, 0x45ef484e, 0xb45d2d80]</span></span><br><span class="line">	<span class="comment">#rst = [0x907CBE0E, 0x68F4E360, 0x8D2AA89A, 0xFCFFBE78]</span></span><br><span class="line">	rst = [<span class="number">0x553786E8</span>, <span class="number">0x9B5D05F5</span>, <span class="number">0x5FDC04DD</span>, <span class="number">0xE12A7721</span>]</span><br><span class="line">	rst_v15 = []</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">36</span>):</span><br><span class="line">		rst_v15.append(<span class="number">0</span>)</span><br><span class="line">	rst_v15[<span class="number">35</span>] = rst[<span class="number">0</span>]</span><br><span class="line">	rst_v15[<span class="number">34</span>] = rst[<span class="number">1</span>]</span><br><span class="line">	rst_v15[<span class="number">33</span>] = rst[<span class="number">2</span>]</span><br><span class="line">	rst_v15[<span class="number">32</span>] = rst[<span class="number">3</span>]</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x20</span>):</span><br><span class="line">		</span><br><span class="line">		ecx = (rst_v15[<span class="number">35</span>-i<span class="number">-1</span>] ^ rst_v15[<span class="number">35</span>-i<span class="number">-2</span>] ^ rst_v15[<span class="number">35</span>-i<span class="number">-3</span>] ^ box[<span class="number">35</span>-i<span class="number">-4</span>])</span><br><span class="line">		idx_a = ecx >> <span class="number">0x18</span></span><br><span class="line">		<span class="comment">#print(hex(ecx))</span></span><br><span class="line">		val_a = byte_7EC3E8[idx_a]</span><br><span class="line">		<span class="comment">#print(hex(val_a))</span></span><br><span class="line">		idx_b = (ecx >> <span class="number">0x10</span>) & <span class="number">0x000000FF</span></span><br><span class="line">		val_b = byte_7EC3E8[idx_b]</span><br><span class="line">		val_ab = val_b | (val_a << <span class="number">8</span>)</span><br><span class="line">		<span class="comment">#print(hex(val_b))</span></span><br><span class="line">		<span class="comment">#print(hex(val_ab))</span></span><br><span class="line">		idx_c = (ecx >> <span class="number">0x8</span>) & <span class="number">0x000000FF</span></span><br><span class="line">		val_c = byte_7EC3E8[idx_c]</span><br><span class="line">		val_abc = val_c | (val_ab << <span class="number">8</span>)</span><br><span class="line">		<span class="comment">#print(hex(val_c))</span></span><br><span class="line">		<span class="comment">#print(hex(val_abc))</span></span><br><span class="line">		idx_d = ecx & <span class="number">0x000000FF</span></span><br><span class="line">		val_d = byte_7EC3E8[idx_d]</span><br><span class="line">		val_abcd = val_d | (val_abc << <span class="number">8</span>)	</span><br><span class="line">		<span class="comment">#print('val_abcd: ', hex(val_abcd))		</span></span><br><span class="line">			</span><br><span class="line">		temp_a = ((val_abcd << <span class="number">18</span>) & <span class="number">0xFFFFFFFF</span>) | (val_abcd >> <span class="number">14</span>) </span><br><span class="line">		temp_b = (val_abcd >> <span class="number">22</span>) | ((val_abcd << <span class="number">10</span>) & <span class="number">0xFFFFFFFF</span>) </span><br><span class="line">		temp_c = ((val_abcd << <span class="number">24</span>) & <span class="number">0xFFFFFFFF</span>) | (val_abcd >> <span class="number">8</span>) </span><br><span class="line">		temp_d = (val_abcd >> <span class="number">30</span>) | ((val_abcd << <span class="number">2</span>) & <span class="number">0xFFFFFFFF</span>) </span><br><span class="line">		<span class="comment">#print(hex(temp_a))</span></span><br><span class="line">		<span class="comment">#print(hex(temp_b))</span></span><br><span class="line">		<span class="comment">#print(hex(temp_c))</span></span><br><span class="line">		<span class="comment">#print(hex(temp_d))</span></span><br><span class="line">		<span class="comment">#print(hex(v15[i]))</span></span><br><span class="line">		rst_v15[<span class="number">35</span>-i<span class="number">-4</span>] = val_abcd ^ rst_v15[<span class="number">35</span>-i] ^ temp_a ^ temp_b ^ temp_c ^ temp_d</span><br><span class="line">		<span class="comment">#print('rst_v15[35-i]: ', hex(rst_v15[35-i]))</span></span><br><span class="line">		print(<span class="string">'rst_v15[35-i-4]: '</span>, hex(rst_v15[<span class="number">35</span>-i<span class="number">-4</span>]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	</span><br><span class="line">	sub_7CD07F_decode(box)</span><br></pre></td></tr></tbody></table></figure></div>

<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_8_1.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_8_1.png"></a>

<ul>
<li>修改box后重新运行一遍解密程序，可以发现，用于匹配的字符串后半部分算出来刚好是0，也就是说，确实只用到了前16字节进行运算。然后我们拼接一下算出的结果，就可以得到”FAA2FBAEDFBAA3C2E3EC40AFCD4D9E43”，与”55555555555555555555555555555555”进行异或，就可以得到”AFF7AEFB8AEFF697B6B915FA9818CB16”。带入到程序中，成功运行</li>
</ul>
<a href="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_8_2.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/step_8_2.png"></a>



<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>在这次一步步摸索做题的过程中，通过不断调整思路，最终找到了题目的几个核心点，只可惜，最后输在了经验。失败总是好事，失败了可以总结可以反思，可以学到更多东西，可以发现自己的盲点，一开始败的很惨也没事，只需要再多败几次，就会比1年前的自己强上个很多倍了！</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ol>
<li><a href="https://blog.csdn.net/qq_37771728/article/details/121680603" target="_blank" rel="noopener">CSDN：关闭随机基址</a></li>
<li><a href="https://ctf.pediy.com/game-season_fight-212.htm" target="_blank" rel="noopener">看雪 2022·KCTF 春季赛 第九题 同归于尽</a></li>
<li><a href="https://bbs.pediy.com/thread-273087.htm" target="_blank" rel="noopener">看雪：mb_mgodlfyn分析文章</a></li>
<li><a href="https://blog.csdn.net/CSNN2019/article/details/117219906" target="_blank" rel="noopener">CSDN：IDA反编译失败总结</a></li>
<li><a href="https://introspelliam.github.io/2017/08/03/re/XMAN%E4%B9%8B%E6%97%85-%E9%80%86%E5%90%91%E5%9F%BA%E7%A1%80%EF%BC%88%E4%B8%8B%EF%BC%89/" target="_blank" rel="noopener">Introspelliam：逆向基础(下)</a></li>
<li><a href="https://bbs.pediy.com/thread-273086.htm" target="_blank" rel="noopener">看雪：ThTsOd分析文章</a></li>
<li><a href="https://bbs.pediy.com/thread-273089.htm" target="_blank" rel="noopener">看雪：上学困难户分析文章</a></li>
<li><a href="https://bbs.pediy.com/thread-273093.htm" target="_blank" rel="noopener">看雪：深山修行之人分析文章</a></li>
<li><a href="https://bbs.pediy.com/thread-271868.htm" target="_blank" rel="noopener">看雪：wx_孤城出题思路</a></li>
<li><a href="https://bbs.pediy.com/thread-273084.htm" target="_blank" rel="noopener">看雪：Emtanling分析文章</a></li>
<li><a href="https://the-x.cn/cryptography/Sm4.aspx" target="_blank" rel="noopener">在线SM4加密/解密</a></li>
</ol>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">cataLoc</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://cata1oc.github.io/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/">http://cata1oc.github.io/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF    </a><a class="post-meta__tags" href="/tags/Windows%E9%80%86%E5%90%91/">Windows逆向    </a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/0x5E.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2022/06/30/%E5%A0%86%E5%9F%BA%E7%A1%8001-ptmalloc2%E5%88%9D%E6%8E%A2/"><img class="prev_cover lazyload" data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/06/30/%E5%A0%86%E5%9F%BA%E7%A1%8001-ptmalloc2%E5%88%9D%E6%8E%A2/0x5F.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Previous Post</div><div class="prev_info"><span>堆基础01：ptmalloc2初探</span></div></a></div><div class="next-post pull_right"><a href="/2022/05/24/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%83%E9%A2%98/"><img class="next_cover lazyload" data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/05/24/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%83%E9%A2%98/0x5D.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>KCTF2022春季赛第七题</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> Recommend</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2021/10/22/KCTF题库-异想天开/" title="KCTF题库：异想天开"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/cover0x4B.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-10-22</div><div class="relatedPosts_title">KCTF题库：异想天开</div></div></a></div><div class="relatedPosts_item"><a href="/2022/05/15/KCTF2022春季赛第三题/" title="KCTF2022春季赛第三题"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/0x5C.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2022-05-15</div><div class="relatedPosts_title">KCTF2022春季赛第三题</div></div></a></div><div class="relatedPosts_item"><a href="/2022/05/13/KCTF2022春季赛第二题/" title="KCTF2022春季赛第二题"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/05/13/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%BA%8C%E9%A2%98/0x5B.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2022-05-13</div><div class="relatedPosts_title">KCTF2022春季赛第二题</div></div></a></div><div class="relatedPosts_item"><a href="/2022/05/24/KCTF2022春季赛第七题/" title="KCTF2022春季赛第七题"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/05/24/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%83%E9%A2%98/0x5D.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2022-05-24</div><div class="relatedPosts_title">KCTF2022春季赛第七题</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/12/一次简单的Hook-下/" title="一次简单的Hook（下）"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-12</div><div class="relatedPosts_title">一次简单的Hook（下）</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/10/一次简单的Hook-上/" title="一次简单的Hook（上）"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-10</div><div class="relatedPosts_title">一次简单的Hook（上）</div></div></a></div></div><div class="clear_both"></div></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2022 By cataLoc</div><div class="framework-info"><span>Driven </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="ribbon_piao" mobile="false" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>