<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>AFL源码分析02：afl-as.c | cataLoc's Blog</title><meta name="description" content="AFL源码分析02：afl-as.c"><meta name="keywords" content="二进制安全,Fuzzing"><meta name="author" content="cataLoc"><meta name="copyright" content="cataLoc"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="AFL源码分析02：afl-as.c"><meta name="twitter:description" content="AFL源码分析02：afl-as.c"><meta name="twitter:image" content="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/01/05/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9002/cover0x51.png"><meta property="og:type" content="article"><meta property="og:title" content="AFL源码分析02：afl-as.c"><meta property="og:url" content="http://cata1oc.github.io/2022/01/05/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9002/"><meta property="og:site_name" content="cataLoc's Blog"><meta property="og:description" content="AFL源码分析02：afl-as.c"><meta property="og:image" content="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/01/05/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9002/cover0x51.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'true'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://cata1oc.github.io/2022/01/05/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9002/"><link rel="prev" title="AFL源码分析03：afl-as.h" href="http://cata1oc.github.io/2022/01/07/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9003/"><link rel="next" title="AFL源码分析01：afl-gcc.c" href="http://cata1oc.github.io/2022/01/02/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9001/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">cataLoc's Blog</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/Substitute.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">144</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">14</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">Catalog</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#前言"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">前言</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#afl-as-c源码分析"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">afl-as.c源码分析</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#关键-全局-变量"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">关键(全局)变量</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#main"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">main</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#edit-params"><span class="toc_mobile_items-number">2.3.</span> <span class="toc_mobile_items-text">edit_params</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#add-instrumentation"><span class="toc_mobile_items-number">2.4.</span> <span class="toc_mobile_items-text">add_instrumentation</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#参考资料"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">参考资料</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#afl-as-c源码分析"><span class="toc-number">2.</span> <span class="toc-text">afl-as.c源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#关键-全局-变量"><span class="toc-number">2.1.</span> <span class="toc-text">关键(全局)变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#main"><span class="toc-number">2.2.</span> <span class="toc-text">main</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#edit-params"><span class="toc-number">2.3.</span> <span class="toc-text">edit_params</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#add-instrumentation"><span class="toc-number">2.4.</span> <span class="toc-text">add_instrumentation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">3.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/01/05/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9002/cover0x51.png)"><div id="post-info"><div id="post-title"><div class="posttitle">AFL源码分析02：afl-as.c</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> Created 2022-01-05<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> Updated 2022-05-17</time><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>Post View:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前一篇分析了afl-gcc，它相当于gcc的一个wrapper，最后会调用实际的gcc，并编辑参数指定汇编器afl-as；本篇则分析（普通）插桩过程中的另一个wrapper：afl-as，他是对GNU as的一个wrapper，会编辑好参数并插桩后，调用实际的as进行汇编操作。</p>
<h2 id="afl-as-c源码分析"><a href="#afl-as-c源码分析" class="headerlink" title="afl-as.c源码分析"></a>afl-as.c源码分析</h2><h3 id="关键-全局-变量"><a href="#关键-全局-变量" class="headerlink" title="关键(全局)变量"></a>关键(全局)变量</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> u8** as_params;          <span class="comment">/* Parameters passed to the real 'as'， 传递给as的参数数组 */</span></span><br><span class="line"><span class="keyword">static</span> u8*  input_file;         <span class="comment">/* Originally specified input file   	指定的输入文件 */</span></span><br><span class="line"><span class="keyword">static</span> u8*  modified_file;      <span class="comment">/* Instrumented file for the real 'as'  经过afl-as进行插桩处理后的文件 */</span></span><br><span class="line"><span class="keyword">static</span> u8   be_quiet,           <span class="comment">/* Quiet mode (no stderr output) */</span></span><br><span class="line">            clang_mode,         <span class="comment">/* Running in clang mode? */</span></span><br><span class="line">            pass_thru,          <span class="comment">/* Just pass data through? */</span></span><br><span class="line">            just_version,       <span class="comment">/* Just show version? */</span></span><br><span class="line">            sanitizer;          <span class="comment">/* Using ASAN/MSAN? */</span></span><br><span class="line"><span class="keyword">static</span> u32  inst_ratio = <span class="number">100</span>,   <span class="comment">/* Instrumentation probability (%) 	插桩覆盖率 */</span></span><br><span class="line">            as_par_cnt = <span class="number">1</span>;     <span class="comment">/* Number of params to 'as' 		用于计算传给as_params数组的参数个数 */</span></span><br></pre></td></tr></tbody></table></figure></div>



<h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 主函数入口点 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>{</span><br><span class="line"></span><br><span class="line">  s32 pid;</span><br><span class="line">  u32 rand_seed;</span><br><span class="line">  <span class="keyword">int</span> status;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">/* 获取环境变量AFL_LAST_RATIO，该环境变量主要控制检测每个分支的概率，</span></span><br><span class="line"><span class="comment">     取值为0~100%，设置为0时则只检测函数入口的跳转，不检测函数分支的跳转 */</span></span><br><span class="line">  u8* inst_ratio_str = getenv(<span class="string">"AFL_INST_RATIO"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">timezone</span> <span class="title">tz</span>;</span></span><br><span class="line"></span><br><span class="line">  clang_mode = !!getenv(CLANG_ENV_VAR);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isatty(<span class="number">2</span>) && !getenv(<span class="string">"AFL_QUIET"</span>)) {</span><br><span class="line">    SAYF(cCYA <span class="string">"afl-as "</span> cBRI VERSION cRST <span class="string">" by <lcamtuf@google.com>\n"</lcamtuf@google.com></span>);</span><br><span class="line"> </span><br><span class="line">  } <span class="keyword">else</span> be_quiet = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc < <span class="number">2</span>) {</span><br><span class="line">    SAYF(<span class="string">"\n"</span></span><br><span class="line">         <span class="string">"This is a helper application for afl-fuzz. It is a wrapper around GNU 'as',\n"</span></span><br><span class="line">         <span class="string">"executed by the toolchain whenever using afl-gcc or afl-clang. You probably\n"</span></span><br><span class="line">         <span class="string">"don't want to run this program directly.\n\n"</span></span><br><span class="line"></span><br><span class="line">         <span class="string">"Rarely, when dealing with extremely complex projects, it may be advisable to\n"</span></span><br><span class="line">         <span class="string">"set AFL_INST_RATIO to a value less than 100 in order to reduce the odds of\n"</span></span><br><span class="line">         <span class="string">"instrumenting every discovered branch.\n\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 通过gettimeofday获取时区和时间，然后设置srandom用的随机种子并进行初始化 */</span>  </span><br><span class="line">  gettimeofday(&tv, &tz);</span><br><span class="line">  rand_seed = tv.tv_sec ^ tv.tv_usec ^ getpid();</span><br><span class="line">  srandom(rand_seed);</span><br><span class="line">    </span><br><span class="line">  <span class="comment">/* 生成实际要执行的as的参数，作用类似afl-gcc.c中的edit_params */</span></span><br><span class="line">  edit_params(argc, argv);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 1.检测inst_ratio_str的值是否在规定范围内</span></span><br><span class="line"><span class="comment">     2.设置环境变量AS_LOOP_ENV_VAR的值 */</span></span><br><span class="line">  <span class="keyword">if</span> (inst_ratio_str) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sscanf</span>(inst_ratio_str, <span class="string">"%u"</span>, &inst_ratio) != <span class="number">1</span> || inst_ratio > <span class="number">100</span>) </span><br><span class="line">      FATAL(<span class="string">"Bad value of AFL_INST_RATIO (must be between 0 and 100)"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (getenv(AS_LOOP_ENV_VAR))</span><br><span class="line">    FATAL(<span class="string">"Endless loop when calling 'as' (remove '.' from your PATH)"</span>);</span><br><span class="line">  setenv(AS_LOOP_ENV_VAR, <span class="string">"1"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 在使用ASAN或MSAN的情况下(即AFL_USE_ASAN/AFL_USE_MASN中有一个值为1)：</span></span><br><span class="line"><span class="comment">  	 1.设置sanitizer的值为1(表明使用了ASAN或MSAN)</span></span><br><span class="line"><span class="comment">  	 2.令inst_ratio除以3，即降低插桩的概率(这是因为AFL无法在插桩的时候识别出</span></span><br><span class="line"><span class="comment">  	 ASAN specific branches，所以会插入很多无意义的桩，为了降低这种概率，粗</span></span><br><span class="line"><span class="comment">  	 暴的将整个插桩的概率都除以3) */</span></span><br><span class="line">  <span class="keyword">if</span> (getenv(<span class="string">"AFL_USE_ASAN"</span>) || getenv(<span class="string">"AFL_USE_MSAN"</span>)) {</span><br><span class="line">    sanitizer = <span class="number">1</span>;</span><br><span class="line">    inst_ratio /= <span class="number">3</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 如果just_version(只显示版本)的值为0</span></span><br><span class="line"><span class="comment">  	 那么调用add_instrumentation进行实际的插桩工作 */</span></span><br><span class="line">  <span class="keyword">if</span> (!just_version) add_instrumentation();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* fork出一个子进程去执行调用实际的汇编器as完成汇编操作</span></span><br><span class="line"><span class="comment">  	 fork函数被调用一次，但返回两次：</span></span><br><span class="line"><span class="comment">  	 	子进程的返回值是0</span></span><br><span class="line"><span class="comment">  	 	父进程的返回值是子进程的Pid */</span></span><br><span class="line">  <span class="keyword">if</span> (!(pid = fork())) {</span><br><span class="line">    execvp(as_params[<span class="number">0</span>], (<span class="keyword">char</span>**)as_params);</span><br><span class="line">    FATAL(<span class="string">"Oops, failed to execute '%s' - check your PATH"</span>, as_params[<span class="number">0</span>]);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pid < <span class="number">0</span>) PFATAL(<span class="string">"fork() failed"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 等待子进程结束 */</span> </span><br><span class="line">  <span class="keyword">if</span> (waitpid(pid, &status, <span class="number">0</span>) <= <span class="number">0</span>) PFATAL(<span class="string">"waitpid() failed"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 读取环境变量AFL_KEEP_ASSEMBLY的值</span></span><br><span class="line"><span class="comment">  	 若不存在该环境变量，则调用unlink移除modified_file(已插桩完成的文件)</span></span><br><span class="line"><span class="comment">     设置该环境变量主要是为了防止afl-as删掉插桩后的汇编文件，设置为1则会保留插桩后的汇编文件</span></span><br><span class="line"><span class="comment">     前面fork一个子进程进行插桩，是为了在执行完实际的as之后，能够unlink掉modified_file */</span></span><br><span class="line">  <span class="keyword">if</span> (!getenv(<span class="string">"AFL_KEEP_ASSEMBLY"</span>)) unlink(modified_file);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span>(WEXITSTATUS(status));</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



<h3 id="edit-params"><a href="#edit-params" class="headerlink" title="edit_params"></a>edit_params</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 调整传递给实际汇编器as的参数，由于filename永远被GCC作为最后一个传递的参数</span></span><br><span class="line"><span class="comment">   利用这个特性可以使代码保持简单 */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">edit_params</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 首先获取环境变量TMPDIR和AFL_AS的值</span></span><br><span class="line"><span class="comment">  	 分别用来设置tmp_dir和afl_as的值 */</span></span><br><span class="line">  u8 *tmp_dir = getenv(<span class="string">"TMPDIR"</span>), *afl_as = getenv(<span class="string">"AFL_AS"</span>);</span><br><span class="line">  u32 i;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 为了解决MacOS X上的过时的as无法正常工作的问题，需要在没有运行afl-as的情况下，</span></span><br><span class="line"><span class="comment">  	 使用'clang -c'而不是'as -q'来编译汇编文件</span></span><br><span class="line"><span class="comment">     这里当处于clang_mode时，且没有没有设置AFL_AS环境变量，</span></span><br><span class="line"><span class="comment">     就设置use_clang_as的值为1，再将afl_as的值设置为AFL_CC/AFL_CXX/clang中的一种 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __APPLE__</span></span><br><span class="line">  u8 use_clang_as = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">if</span> (clang_mode && !afl_as) {</span><br><span class="line">    use_clang_as = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    afl_as = getenv(<span class="string">"AFL_CC"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!afl_as) afl_as = getenv(<span class="string">"AFL_CXX"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!afl_as) afl_as = <span class="string">"clang"</span>;</span><br><span class="line">  }</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  <span class="comment">/* 当环境变量TMPDIR没有设置时，GCC也会使用环境变量TMP和TEMP</span></span><br><span class="line"><span class="comment">  	 所以都需要检查一下。如果一直为空，就将tmp_dir设置为'/tmp' */</span></span><br><span class="line">  <span class="keyword">if</span> (!tmp_dir) tmp_dir = getenv(<span class="string">"TEMP"</span>);</span><br><span class="line">  <span class="keyword">if</span> (!tmp_dir) tmp_dir = getenv(<span class="string">"TMP"</span>);</span><br><span class="line">  <span class="keyword">if</span> (!tmp_dir) tmp_dir = <span class="string">"/tmp"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 1.为as的参数数组开辟空间，大小(argc+32)*8</span></span><br><span class="line"><span class="comment">  	 2.若afl_as存在，则设置as_params数组第一个参数为afl_as的值，否则设置为'as' </span></span><br><span class="line"><span class="comment">  	 3.设置as_params数组的截断位置 */</span></span><br><span class="line">  as_params = ck_alloc((argc + <span class="number">32</span>) * <span class="keyword">sizeof</span>(u8*));</span><br><span class="line">  as_params[<span class="number">0</span>] = afl_as ? afl_as : (u8*)<span class="string">"as"</span>;</span><br><span class="line">  as_params[argc] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 从argv[1]开始遍历(注意初始化全局变量时as_par_cnt设置为1)，</span></span><br><span class="line"><span class="comment">  	 	如果遇到参数为'--64'，则设置use_64bit的值</span></span><br><span class="line"><span class="comment">  	 	如果遇到参数为'--32'，则清除use_64bit的值 */</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">1</span>; i < argc - <span class="number">1</span>; i++) {</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i], <span class="string">"--64"</span>)) use_64bit = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i], <span class="string">"--32"</span>)) use_64bit = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 如果是Apple系统：</span></span><br><span class="line"><span class="comment">       1.对于use_64bit的设置和清除操作会有一点点不同</span></span><br><span class="line"><span class="comment">       2.需要去掉那些特定于Xcode中的前端汇编器的选项(即参数'-q'和'-Q') */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __APPLE__</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i], <span class="string">"-arch"</span>) && i + <span class="number">1</span> < argc) {</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i + <span class="number">1</span>], <span class="string">"x86_64"</span>)) use_64bit = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i + <span class="number">1</span>], <span class="string">"i386"</span>))</span><br><span class="line">        FATAL(<span class="string">"Sorry, 32-bit Apple platforms are not supported."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clang_mode && (!<span class="built_in">strcmp</span>(argv[i], <span class="string">"-q"</span>) || !<span class="built_in">strcmp</span>(argv[i], <span class="string">"-Q"</span>)))</span><br><span class="line">      <span class="keyword">continue</span>;      </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">    as_params[as_par_cnt++] = argv[i];</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  <span class="comment">/* 如果是Apple系统，当调用clang作为前端汇编器时，最好添加上参数'-c -x assembler' */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __APPLE__    </span></span><br><span class="line">  <span class="keyword">if</span> (use_clang_as) {</span><br><span class="line">    as_params[as_par_cnt++] = <span class="string">"-c"</span>;</span><br><span class="line">    as_params[as_par_cnt++] = <span class="string">"-x"</span>;</span><br><span class="line">    as_params[as_par_cnt++] = <span class="string">"assembler"</span>;</span><br><span class="line">  }</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  <span class="comment">/* 下面开始设置as_params数组中的其它参数</span></span><br><span class="line"><span class="comment">  	 首先从GCC传进来的最后一个参数拿到input_file */</span></span><br><span class="line">  input_file = argv[argc - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 判断input_file的第一个参数是不是字符'-'开头</span></span><br><span class="line"><span class="comment">  		如果是'-'开头，判断第一个参数是不是-version</span></span><br><span class="line"><span class="comment">  			如果是-version：</span></span><br><span class="line"><span class="comment">  			1.设置just_version的值为1</span></span><br><span class="line"><span class="comment">  			2.不对input_file进行修改直接赋给modified_file</span></span><br><span class="line"><span class="comment">  			3.跳转到wrap_things_up执行 */</span></span><br><span class="line">  <span class="keyword">if</span> (input_file[<span class="number">0</span>] == <span class="string">'-'</span>) {</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(input_file + <span class="number">1</span>, <span class="string">"-version"</span>)) {</span><br><span class="line">      just_version = <span class="number">1</span>;</span><br><span class="line">      modified_file = input_file;</span><br><span class="line">      <span class="keyword">goto</span> wrap_things_up;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (input_file[<span class="number">1</span>]) FATAL(<span class="string">"Incorrect use (not called through afl-gcc?)"</span>);</span><br><span class="line">      <span class="keyword">else</span> input_file = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 分别判断input_file和tmp_dir、/var/tmp的前9个字节、/tmp的前5个字节是否相同，</span></span><br><span class="line"><span class="comment">       如果不相同，则设置pass_thru的值为1(这里检查是否为一次尝试编译程序时的标准调用) */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_file, tmp_dir, <span class="built_in">strlen</span>(tmp_dir)) &&</span><br><span class="line">        <span class="built_in">strncmp</span>(input_file, <span class="string">"/var/tmp/"</span>, <span class="number">9</span>) &&</span><br><span class="line">        <span class="built_in">strncmp</span>(input_file, <span class="string">"/tmp/"</span>, <span class="number">5</span>)) pass_thru = <span class="number">1</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 将modified_file设置为诸如tmp_dir/.afl-pid-time.s形式的字符串 */</span></span><br><span class="line">  modified_file = alloc_printf(<span class="string">"%s/.afl-%u-%u.s"</span>, tmp_dir, getpid(),</span><br><span class="line">                               (u32)time(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 进入warp_things_up后，会向as_params添加参数modified_file</span></span><br><span class="line"><span class="comment">  	 之后用NULL截断数组，完成对as_params的编辑 */</span></span><br><span class="line">wrap_things_up:</span><br><span class="line">    </span><br><span class="line">  as_params[as_par_cnt++] = modified_file;</span><br><span class="line">  as_params[as_par_cnt]   = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>编辑afl-as.c，在main函数中，调用edit_params之后添加如下代码，打印as_params来查看实际执行的命令</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i < as_par_cnt; i++) {</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"\targ%d: %s\n"</span>, i, as_params[i]);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>然后执行</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo make install</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>即可查看打印的参数</p>
<a href="/2022/01/05/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9002/edit_params_1.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/01/05/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9002/edit_params_1.png"></a>

<p>可以看到，在执行afl-gcc的时候，会调用到实际的gcc，并在之后进一步调用了afl-as，最后afl-as也会去调用实际的as完成整个汇编的过程。其中在afl-as阶段，主要完成的就是插桩部分的操作，这些工作交由add_instrumentation函数完成。</p>
<h3 id="add-instrumentation"><a href="#add-instrumentation" class="headerlink" title="add_instrumentation"></a>add_instrumentation</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 输入原始文件，插桩到适当位置，生成插桩后的文件 */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add_instrumentation</span><span class="params">(<span class="keyword">void</span>)</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> u8 <span class="built_in">line</span>[MAX_LINE];</span><br><span class="line"></span><br><span class="line">  FILE* inf;</span><br><span class="line">  FILE* outf;</span><br><span class="line">  s32 outfd;</span><br><span class="line">  u32 ins_lines = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  u8  instr_ok = <span class="number">0</span>, skip_csect = <span class="number">0</span>, skip_next_label = <span class="number">0</span>,</span><br><span class="line">      skip_intel = <span class="number">0</span>, skip_app = <span class="number">0</span>, instrument_next = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __APPLE__</span></span><br><span class="line">  u8* colon_pos;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  <span class="comment">/* 如果input_file不为空，则尝试打开这个文件，如果打开失败就抛出异常</span></span><br><span class="line"><span class="comment">  	 如果input_file为空，则从标准输入读取这个文件 */</span></span><br><span class="line">  <span class="keyword">if</span> (input_file) {</span><br><span class="line">    inf = fopen(input_file, <span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!inf) PFATAL(<span class="string">"Unable to read '%s'"</span>, input_file);</span><br><span class="line"></span><br><span class="line">  } <span class="keyword">else</span> inf = <span class="built_in">stdin</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 创建modified_file文件(这里O_EXCL是确保此次调用创建了这个文件)</span></span><br><span class="line"><span class="comment">  	 然后调用fdopen，将modified_file的文件指针保存在outf中 */</span> </span><br><span class="line">  outfd = <span class="built_in">open</span>(modified_file, O_WRONLY | O_EXCL | O_CREAT, <span class="number">0600</span>);</span><br><span class="line">  <span class="keyword">if</span> (outfd < <span class="number">0</span>) </span><br><span class="line">      PFATAL(<span class="string">"Unable to write to '%s'"</span>, modified_file);</span><br><span class="line">  outf = fdopen(outfd, <span class="string">"w"</span>);</span><br><span class="line">  <span class="keyword">if</span> (!outf) </span><br><span class="line">      PFATAL(<span class="string">"fdopen() failed"</span>);  </span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 逐行读取输入文件的内容，并保存到line数组里，每行最多读取MAX_LINE-1个字节(去掉最后的'\0')</span></span><br><span class="line"><span class="comment">  	 再从line数组里将读取的内容写入到outf指向的文件里 */</span></span><br><span class="line">  <span class="keyword">while</span> (fgets(<span class="built_in">line</span>, MAX_LINE, inf)) {</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/* 检查pass_thru、skip_intel、skip_app、skip_csect是值是否都为0</span></span><br><span class="line"><span class="comment">       检查instr_ok、instrument_next的值是否都为1 </span></span><br><span class="line"><span class="comment">       检查line是否以\t开始，line[1]是否为字母</span></span><br><span class="line"><span class="comment">       这么做，是为了跳过标签，宏，注释 */</span>  </span><br><span class="line">    <span class="keyword">if</span> (!pass_thru && !skip_intel && !skip_app && !skip_csect && instr_ok &&</span><br><span class="line">        instrument_next && <span class="built_in">line</span>[<span class="number">0</span>] == <span class="string">'\t'</span> && <span class="built_in">isalpha</span>(<span class="built_in">line</span>[<span class="number">1</span>])) {</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* 如果以上条件都满足，则对以defered mode进行插桩的位置开始插桩处理：</span></span><br><span class="line"><span class="comment">      	 1.进行插桩，将trampoline_fmt写入outf，也就是modified_file</span></span><br><span class="line"><span class="comment">         2.设置instrument_next的值为0 </span></span><br><span class="line"><span class="comment">         3.插桩计数器ins_lines的值加1 */</span></span><br><span class="line">      <span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</span><br><span class="line">              R(MAP_SIZE));</span><br><span class="line"></span><br><span class="line">      instrument_next = <span class="number">0</span>;</span><br><span class="line">      ins_lines++;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 将原本的指令写入到outf；如果是pass_thru模式下，就回到循环开始处读取下一行数据 */</span></span><br><span class="line">    <span class="built_in">fputs</span>(<span class="built_in">line</span>, outf);</span><br><span class="line">    <span class="keyword">if</span> (pass_thru) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 这里可以认为是插桩程序真正的开始位置：</span></span><br><span class="line"><span class="comment">          1.AFL只关心对.text节的插桩，根据对处理文件的追踪，会相应的</span></span><br><span class="line"><span class="comment">            设置instr_ok的值(该值被设置时代表此时位于.text节) </span></span><br><span class="line"><span class="comment">          2.OpenBSD系统会将跳转表直接放在代码中。跳转表附近会有特定格</span></span><br><span class="line"><span class="comment">            式的p2align指令，可以将其作为信号 */</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">/* 如果line以'\t.'开头，则进行如下判断：</span></span><br><span class="line"><span class="comment">          如果满足如下条件：</span></span><br><span class="line"><span class="comment">             1.clang_mode值为0</span></span><br><span class="line"><span class="comment">             2.instr_ok值为1(位于.text节)</span></span><br><span class="line"><span class="comment">             3.line=='\t.p2align '</span></span><br><span class="line"><span class="comment">             4.line[10]是数字</span></span><br><span class="line"><span class="comment">             5.line[11]=='\n'</span></span><br><span class="line"><span class="comment">             则设置skip_next_label的值为1		</span></span><br><span class="line"><span class="comment">          如果line的值为'\t.text\n'或'\t.section\t.text'或'\t.section\t__TEXT,__text'或'\t.section __TEXT,__text'</span></span><br><span class="line"><span class="comment">             则设置instr_ok的值为1，并跳回循环开始处，读取下一行的数据到line里</span></span><br><span class="line"><span class="comment">          如果line的值为'\t.section\t' '\t.section' '\t.bss' '\t.data'</span></span><br><span class="line"><span class="comment">             则设置instr_ok的值为0，并跳回循环开始处，读取下一行的数据到line里 */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">line</span>[<span class="number">0</span>] == <span class="string">'\t'</span> && <span class="built_in">line</span>[<span class="number">1</span>] == <span class="string">'.'</span>) {</span><br><span class="line">      <span class="keyword">if</span> (!clang_mode && instr_ok && !<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"p2align "</span>, <span class="number">8</span>) &&</span><br><span class="line">          <span class="built_in">isdigit</span>(<span class="built_in">line</span>[<span class="number">10</span>]) && <span class="built_in">line</span>[<span class="number">11</span>] == <span class="string">'\n'</span>) </span><br><span class="line">          skip_next_label = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"text\n"</span>, <span class="number">5</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"section\t.text"</span>, <span class="number">13</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"section\t__TEXT,__text"</span>, <span class="number">21</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"section __TEXT,__text"</span>, <span class="number">21</span>)) {</span><br><span class="line">        instr_ok = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>; </span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"section\t"</span>, <span class="number">8</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"section "</span>, <span class="number">8</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"bss\n"</span>, <span class="number">4</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"data\n"</span>, <span class="number">5</span>)) {</span><br><span class="line">        instr_ok = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Detect off-flavor assembly (rare, happens in gdb). When this is</span></span><br><span class="line"><span class="comment">       encountered, we set skip_csect until the opposite directive is</span></span><br><span class="line"><span class="comment">       seen, and we do not instrument. */</span></span><br><span class="line">    <span class="comment">/* 检测off-flavor编码(很少见，仅出现在gdb中)，遇到此类情况时，将对skip_csect</span></span><br><span class="line"><span class="comment">       进行设置，并且不进行插桩操作 */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(<span class="built_in">line</span>, <span class="string">".code"</span>)) {</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strstr</span>(<span class="built_in">line</span>, <span class="string">".code32"</span>)) skip_csect = use_64bit;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strstr</span>(<span class="built_in">line</span>, <span class="string">".code64"</span>)) skip_csect = !use_64bit;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 检查语法变化，通常只发生在硬编码写入的情况，跳过Intel语法的指令块，当回到</span></span><br><span class="line"><span class="comment">       AT&T指令块时恢复插桩 */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(<span class="built_in">line</span>, <span class="string">".intel_syntax"</span>)) skip_intel = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(<span class="built_in">line</span>, <span class="string">".att_syntax"</span>)) skip_intel = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 检测并跳过临时的__asm__块，即不对内联汇编进行插桩 */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">line</span>[<span class="number">0</span>] == <span class="string">'#'</span> || <span class="built_in">line</span>[<span class="number">1</span>] == <span class="string">'#'</span>) {</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strstr</span>(<span class="built_in">line</span>, <span class="string">"#APP"</span>)) skip_app = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strstr</span>(<span class="built_in">line</span>, <span class="string">"#NO_APP"</span>)) skip_app = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">      </span><br><span class="line">    <span class="comment">/* 如果出现以下的情况，则回到循环开始处，读取下一行的内容到line：</span></span><br><span class="line"><span class="comment">          1.设置了skip_intel或skip_app或skip_csect的值</span></span><br><span class="line"><span class="comment">          2.instr_ok的值为0</span></span><br><span class="line"><span class="comment">          3.line[0]的值为'#'或' ' */</span></span><br><span class="line">    <span class="keyword">if</span> (skip_intel || skip_app || skip_csect || !instr_ok ||</span><br><span class="line">        <span class="built_in">line</span>[<span class="number">0</span>] == <span class="string">'#'</span> || <span class="built_in">line</span>[<span class="number">0</span>] == <span class="string">' '</span>)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we're in the right mood for instrumenting, check for function</span></span><br><span class="line"><span class="comment">       names or conditional labels. This is a bit messy, but in essence,</span></span><br><span class="line"><span class="comment">       we want to catch:</span></span><br><span class="line"><span class="comment">         ^main:      - function entry point (always instrumented)</span></span><br><span class="line"><span class="comment">         ^.L0:       - GCC branch label</span></span><br><span class="line"><span class="comment">         ^.LBB0_0:   - clang branch label (but only in clang mode)</span></span><br><span class="line"><span class="comment">         ^\tjnz foo  - conditional branches</span></span><br><span class="line"><span class="comment">       ...but not:</span></span><br><span class="line"><span class="comment">         ^# BB#0:    - clang comments</span></span><br><span class="line"><span class="comment">         ^ # BB#0:   - ditto</span></span><br><span class="line"><span class="comment">         ^.Ltmp0:    - clang non-branch labels</span></span><br><span class="line"><span class="comment">         ^.LC0       - GCC non-branch labels</span></span><br><span class="line"><span class="comment">         ^.LBB0_0:   - ditto (when in GCC mode)</span></span><br><span class="line"><span class="comment">         ^\tjmp foo  - non-conditional jumps</span></span><br><span class="line"><span class="comment">       Additionally, clang and GCC on MacOS X follow a different convention</span></span><br><span class="line"><span class="comment">       with no leading dots on labels, hence the weird maze of #ifdefs</span></span><br><span class="line"><span class="comment">       later on.</span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">   	   Conditional branch instruction (jnz, etc). We append the instrumentation</span></span><br><span class="line"><span class="comment">       right after the branch (to instrument the not-taken path) and at the</span></span><br><span class="line"><span class="comment">       branch destination label (handled later on). */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* #define R(x) (random() % (x))   --> 定义在types.h中</span></span><br><span class="line"><span class="comment">       这里的随机性使得可以唯一定位程序运行的位置(不考虑碰撞的情况下)</span></span><br><span class="line"><span class="comment">     </span></span><br><span class="line"><span class="comment">       如果line以'\tj[!m]'开头，且R(100)小于插桩密度inst_ratio，则</span></span><br><span class="line"><span class="comment">    		1.进行插桩，将trampoline_fmt写入outf，也就是modified_file</span></span><br><span class="line"><span class="comment">         	2.插桩计数器ins_lines的值加1 */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">line</span>[<span class="number">0</span>] == <span class="string">'\t'</span>) {</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">line</span>[<span class="number">1</span>] == <span class="string">'j'</span> && <span class="built_in">line</span>[<span class="number">2</span>] != <span class="string">'m'</span> && R(<span class="number">100</span>) < inst_ratio) {</span><br><span class="line">        <span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</span><br><span class="line">                R(MAP_SIZE));</span><br><span class="line"></span><br><span class="line">        ins_lines++;</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">    <span class="comment">/* Label of some sort. This may be a branch destination, but we need to</span></span><br><span class="line"><span class="comment">       tread carefully and account for several different formatting</span></span><br><span class="line"><span class="comment">       conventions.</span></span><br><span class="line"><span class="comment">       以下是对一些标签(label)进行评估，有一些标签可能是一些分支的目的地，需要单独评判 */</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">/* Apple: L<whatever><digit>: </digit></whatever></span></span><br><span class="line"><span class="comment">       对于Apple系统，检查是否存在line=='L:<whatever><digit>:'的情况 */</digit></whatever></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __APPLE__ </span></span><br><span class="line">    <span class="keyword">if</span> ((colon_pos = <span class="built_in">strstr</span>(<span class="built_in">line</span>, <span class="string">":"</span>))) {</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">line</span>[<span class="number">0</span>] == <span class="string">'L'</span> && <span class="built_in">isdigit</span>(*(colon_pos - <span class="number">1</span>))) {</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Everybody else: .L<whatever>: */</whatever></span></span><br><span class="line">	<span class="comment">/* 对于Apple以外的系统，检查是否存在line=='.L<whatever>:'的情况 */</whatever></span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(<span class="built_in">line</span>, <span class="string">":"</span>)) {</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">line</span>[<span class="number">0</span>] == <span class="string">'.'</span>) {</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">          </span><br><span class="line">        <span class="comment">/* .L0: or LBB0_0: style jump destination </span></span><br><span class="line"><span class="comment">        	以下是对形如'.L0'或者'LBB0_0'这样格式的分支标签进行筛选 */</span></span><br><span class="line">          </span><br><span class="line">        <span class="comment">/* Apple: L<num> / LBB<num> </num></num></span></span><br><span class="line"><span class="comment">           对于Apple系统，筛选2种情况：</span></span><br><span class="line"><span class="comment">           1.line=='L<num>:' 并且 R(100) < inst_ratio</num></span></span><br><span class="line"><span class="comment">           2.line=='LBB<num>:' 并且 clang_mode==1 并且 R(100) < inst_ratio */</num></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __APPLE__         </span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(<span class="built_in">line</span>[<span class="number">1</span>]) || (clang_mode && !<span class="built_in">strncmp</span>(<span class="built_in">line</span>, <span class="string">"LBB"</span>, <span class="number">3</span>)))</span><br><span class="line">            && R(<span class="number">100</span>) < inst_ratio) {</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Everybody else: .L<num> / .LBB<num> </num></num></span></span><br><span class="line"><span class="comment">           对于Apple以外的系统，筛选2种情况：</span></span><br><span class="line"><span class="comment">           1.line=='.L<num>:' 并且 R(100) < inst_ratio</num></span></span><br><span class="line"><span class="comment">           2.line=='.LBB<num>:' 并且 clang_mode==1 并且 R(100) < inst_ratio */</num></span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(<span class="built_in">line</span>[<span class="number">2</span>]) || (clang_mode && !<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">1</span>, <span class="string">"LBB"</span>, <span class="number">3</span>)))</span><br><span class="line">            && R(<span class="number">100</span>) < inst_ratio) {</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">          <span class="comment">/* An optimization is possible here by adding the code only if the</span></span><br><span class="line"><span class="comment">             label is mentioned in the code in contexts other than call / jmp.</span></span><br><span class="line"><span class="comment">             That said, this complicates the code by requiring two-pass</span></span><br><span class="line"><span class="comment">             processing (messy with stdin), and results in a speed gain</span></span><br><span class="line"><span class="comment">             typically under 10%, because compilers are generally pretty good</span></span><br><span class="line"><span class="comment">             about not generating spurious intra-function jumps.</span></span><br><span class="line"><span class="comment">             We use deferred output chiefly to avoid disrupting</span></span><br><span class="line"><span class="comment">             .Lfunc_begin0-style exception handling calculations (a problem on</span></span><br><span class="line"><span class="comment">             MacOS X). */</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment">/* 如果满足上述筛选条件：</span></span><br><span class="line"><span class="comment">                如果skip_next_label值为0，就设置instrument_next值为1</span></span><br><span class="line"><span class="comment">                否则，设置skip_next_label值为0 */</span></span><br><span class="line">          <span class="keyword">if</span> (!skip_next_label) </span><br><span class="line">              instrument_next = <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">              skip_next_label = <span class="number">0</span>;</span><br><span class="line">        }</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Function label (always instrumented, deferred mode). </span></span><br><span class="line"><span class="comment">        如果未满足前面的筛选条件，说明这是一个函数入口点，</span></span><br><span class="line"><span class="comment">        则设置instrument_next值为1，表明是defered mode */</span></span><br><span class="line">        instrument_next = <span class="number">1</span>;   </span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 如果插桩计数器ins_lines的值不为0，就在input_file拷贝完成后，</span></span><br><span class="line"><span class="comment">     向outf中写入main_payload，然后关闭input_file和modified_file */</span></span><br><span class="line">  <span class="keyword">if</span> (ins_lines)</span><br><span class="line">    <span class="built_in">fputs</span>(use_64bit ? main_payload_64 : main_payload_32, outf);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (input_file) fclose(inf);</span><br><span class="line">  fclose(outf);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!be_quiet) {</span><br><span class="line">    <span class="keyword">if</span> (!ins_lines) WARNF(<span class="string">"No instrumentation targets found%s."</span>,</span><br><span class="line">                          pass_thru ? <span class="string">" (pass-thru mode)"</span> : <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">else</span> OKF(<span class="string">"Instrumented %u locations (%s-bit, %s mode, ratio %u%%)."</span>,</span><br><span class="line">             ins_lines, use_64bit ? <span class="string">"64"</span> : <span class="string">"32"</span>,</span><br><span class="line">             getenv(<span class="string">"AFL_HARDEN"</span>) ? <span class="string">"hardened"</span> : </span><br><span class="line">             (sanitizer ? <span class="string">"ASAN/MSAN"</span> : <span class="string">"non-hardened"</span>),</span><br><span class="line">             inst_ratio);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>分析完add_instrumentation函数，可以了解到该函数会经过一系列判断，在代码段中的主要分支和条件分支中插入桩代码，并输入modified_file。这里，还有一部分的内容尚未了解，就是这些桩代码，是如何反馈出覆盖率的，桩代码到底实现了什么？要了解这些，还需要分析（普通）插桩流程涉及到的最后一个文件afl-as.h，我们将在下一篇中对此进行分析。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a href="https://blog.csdn.net/qq_41202237/article/details/121332118?spm=1001.2014.3001.5501" target="_blank" rel="noopener">hollk：AFL源码分析之afl-as.c详细注释</a></li>
<li><a href="https://eternalsakura13.com/2020/08/23/afl/" target="_blank" rel="noopener">skr：sakuraのAFL源码全注释</a></li>
<li><a href="https://paper.seebug.org/1732/" target="_blank" rel="noopener">Seebug：AFL 二三事——源码分析</a></li>
<li><a href="http://rk700.github.io/2017/12/28/afl-internals/" target="_blank" rel="noopener">AFL内部实现细节小记</a></li>
<li><a href="https://github.com/google/AFL/blob/master/afl-as.c" target="_blank" rel="noopener">AFL：afl-as.c</a></li>
<li><a href="https://hicookie.me/2019/09/18/AFL-Learning/" target="_blank" rel="noopener">HICOOKIE：AFL-Learning</a></li>
<li><a href="https://www.jianshu.com/p/2da850f32b2d" target="_blank" rel="noopener">简书：AFL源码分析</a></li>
</ol>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">cataLoc</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://cata1oc.github.io/2022/01/05/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9002/">http://cata1oc.github.io/2022/01/05/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9002/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/">二进制安全    </a><a class="post-meta__tags" href="/tags/Fuzzing/">Fuzzing    </a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/01/05/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9002/cover0x51.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2022/01/07/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9003/"><img class="prev_cover lazyload" data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/01/07/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9003/cover0x52.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Previous Post</div><div class="prev_info"><span>AFL源码分析03：afl-as.h</span></div></a></div><div class="next-post pull_right"><a href="/2022/01/02/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9001/"><img class="next_cover lazyload" data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/01/02/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9001/cover0x50.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>AFL源码分析01：afl-gcc.c</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> Recommend</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2022/01/02/AFL源码分析01/" title="AFL源码分析01：afl-gcc.c"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/01/02/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9001/cover0x50.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2022-01-02</div><div class="relatedPosts_title">AFL源码分析01：afl-gcc.c</div></div></a></div><div class="relatedPosts_item"><a href="/2021/12/22/AFL环境搭建/" title="AFL环境搭建"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2021/12/22/AFL%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/cover0x4F.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-12-22</div><div class="relatedPosts_title">AFL环境搭建</div></div></a></div><div class="relatedPosts_item"><a href="/2022/01/07/AFL源码分析03/" title="AFL源码分析03：afl-as.h"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/01/07/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9003/cover0x52.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2022-01-07</div><div class="relatedPosts_title">AFL源码分析03：afl-as.h</div></div></a></div><div class="relatedPosts_item"><a href="/2022/02/06/AFL源码分析04/" title="AFL源码分析04：afl-fuzz.c"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/02/06/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9004/cover0x53.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2022-02-06</div><div class="relatedPosts_title">AFL源码分析04：afl-fuzz.c</div></div></a></div><div class="relatedPosts_item"><a href="/2022/03/12/AFL源码分析05/" title="AFL源码分析05：fuzz_one"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/03/12/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9005/cover0x54.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2022-03-12</div><div class="relatedPosts_title">AFL源码分析05：fuzz_one</div></div></a></div><div class="relatedPosts_item"><a href="/2021/10/31/初探GOT与PLT/" title="初探GOT与PLT"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2021/10/31/%E5%88%9D%E6%8E%A2GOT%E4%B8%8EPLT/cover0x4C.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-10-31</div><div class="relatedPosts_title">初探GOT与PLT</div></div></a></div></div><div class="clear_both"></div></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2022 By cataLoc</div><div class="framework-info"><span>Driven </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="ribbon_piao" mobile="false" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>