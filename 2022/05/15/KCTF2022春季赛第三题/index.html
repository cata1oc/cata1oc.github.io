<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>KCTF2022春季赛第三题 | cataLoc's Blog</title><meta name="description" content="KCTF2022春季赛第三题"><meta name="keywords" content="CTF,Windows逆向"><meta name="author" content="cataLoc"><meta name="copyright" content="cataLoc"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="KCTF2022春季赛第三题"><meta name="twitter:description" content="KCTF2022春季赛第三题"><meta name="twitter:image" content="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/0x5C.png"><meta property="og:type" content="article"><meta property="og:title" content="KCTF2022春季赛第三题"><meta property="og:url" content="http://cata1oc.github.io/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/"><meta property="og:site_name" content="cataLoc's Blog"><meta property="og:description" content="KCTF2022春季赛第三题"><meta property="og:image" content="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/0x5C.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'true'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://cata1oc.github.io/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/"><link rel="prev" title="KCTF2022春季赛第七题" href="http://cata1oc.github.io/2022/05/24/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%83%E9%A2%98/"><link rel="next" title="KCTF2022春季赛第二题" href="http://cata1oc.github.io/2022/05/13/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%BA%8C%E9%A2%98/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">cataLoc's Blog</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/Substitute.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">150</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">14</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">Catalog</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#前言"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">前言</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#分析流程"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">分析流程</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#异常处理"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">异常处理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Findcrypt"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">Findcrypt</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#MD5-Encrypt"><span class="toc_mobile_items-number">2.3.</span> <span class="toc_mobile_items-text">MD5_Encrypt</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#参数分析"><span class="toc_mobile_items-number">2.3.1.</span> <span class="toc_mobile_items-text">参数分析</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#AES-Encrypt"><span class="toc_mobile_items-number">2.4.</span> <span class="toc_mobile_items-text">AES_Encrypt</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#参数分析-1"><span class="toc_mobile_items-number">2.4.1.</span> <span class="toc_mobile_items-text">参数分析</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#AES算法"><span class="toc_mobile_items-number">2.4.2.</span> <span class="toc_mobile_items-text">AES算法</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#KeyExpansion"><span class="toc_mobile_items-number">2.4.3.</span> <span class="toc_mobile_items-text">KeyExpansion</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#Load-StoreStateArray"><span class="toc_mobile_items-number">2.4.4.</span> <span class="toc_mobile_items-text">Load&#x2F;StoreStateArray</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#AddRoundKey"><span class="toc_mobile_items-number">2.4.5.</span> <span class="toc_mobile_items-text">AddRoundKey</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#SubBytes"><span class="toc_mobile_items-number">2.4.6.</span> <span class="toc_mobile_items-text">SubBytes</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#ShiftRows"><span class="toc_mobile_items-number">2.4.7.</span> <span class="toc_mobile_items-text">ShiftRows</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#MixColumns"><span class="toc_mobile_items-number">2.4.8.</span> <span class="toc_mobile_items-text">MixColumns</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#失败的还原"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">失败的还原</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#大佬思路"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">大佬思路</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#参考链接"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">参考链接</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分析流程"><span class="toc-number">2.</span> <span class="toc-text">分析流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#异常处理"><span class="toc-number">2.1.</span> <span class="toc-text">异常处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Findcrypt"><span class="toc-number">2.2.</span> <span class="toc-text">Findcrypt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MD5-Encrypt"><span class="toc-number">2.3.</span> <span class="toc-text">MD5_Encrypt</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#参数分析"><span class="toc-number">2.3.1.</span> <span class="toc-text">参数分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AES-Encrypt"><span class="toc-number">2.4.</span> <span class="toc-text">AES_Encrypt</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#参数分析-1"><span class="toc-number">2.4.1.</span> <span class="toc-text">参数分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AES算法"><span class="toc-number">2.4.2.</span> <span class="toc-text">AES算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#KeyExpansion"><span class="toc-number">2.4.3.</span> <span class="toc-text">KeyExpansion</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Load-StoreStateArray"><span class="toc-number">2.4.4.</span> <span class="toc-text">Load&#x2F;StoreStateArray</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AddRoundKey"><span class="toc-number">2.4.5.</span> <span class="toc-text">AddRoundKey</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SubBytes"><span class="toc-number">2.4.6.</span> <span class="toc-text">SubBytes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ShiftRows"><span class="toc-number">2.4.7.</span> <span class="toc-text">ShiftRows</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MixColumns"><span class="toc-number">2.4.8.</span> <span class="toc-text">MixColumns</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#失败的还原"><span class="toc-number">3.</span> <span class="toc-text">失败的还原</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#大佬思路"><span class="toc-number">4.</span> <span class="toc-text">大佬思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考链接"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/0x5C.png)"><div id="post-info"><div id="post-title"><div class="posttitle">KCTF2022春季赛第三题</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> Created 2022-05-15<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> Updated 2022-05-20</time><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>Post View:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这是一次失败的经历，从周五放出题开始，不到2个小时，就有人解出题目，上午刚刚写完wp的喜悦瞬间消散，开始着手准备解题。这一天没有进展。直至第二天傍晚，才开始有所眉目。所谓的异常处理，并不会对解题有太大影响，相反，题目算法本身的复杂度，成了影响的关键因素，从周六傍晚开始逆算法，直至第二天凌晨4点30，终于逆出了完整的算法，此时我已精疲力竭。然而，仅有算法还不足以解题，需要逆算法才可以，此时精力已经不足，在进行一些简单的尝试后，遂放弃了此题。</p>
<p>中午过后，公开了各个大佬的wp，发现自己原来把魔改后的AES逆了一遍，显得有些愚蠢、呆板，但是看着大佬们的解题思路，豁然开朗，这是一次绝佳的学习机会，所以，趁着现在对该题还有印象，又不想浪费自己的分析，这里会结合各个大佬的wp，简单分析一下程序的坑点和流程。并在最后，依次分析大佬们的解题思路和思维方式。</p>
<h2 id="分析流程"><a href="#分析流程" class="headerlink" title="分析流程"></a>分析流程</h2><h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><a href="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/exception.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/exception.png"></a>

<ul>
<li><p><strong>问题描述</strong>：该题的第一个坎是异常处理，如图中所示，红色方框会向0地址写入数据，从而触发异常。本题中引发异常的位置还有若干个，触发异常后，再在异常处理函数中修正EIP的值。</p>
</li>
<li><p><strong>解决方案</strong>：</p>
<ol>
<li>理解异常发生后的程序控制流，patch程序让程序的控制流恢复正常，这里可以参考以下两篇<a href="https://www.jianshu.com/p/9ff977ded99d" target="_blank" rel="noopener">“看雪CTF签到题SEH异常处理”</a>与<a href="https://blog.csdn.net/w1012747007/article/details/77131781" target="_blank" rel="noopener">“SEH的非常好的总结”</a>关于SEH机制的文章</li>
<li>较为密集的下断点，从而推测出程序的执行流程。例如这里，可在图中橙色方框伪代码对应的汇编处下断点</li>
</ol>
</li>
</ul>
<h3 id="Findcrypt"><a href="#Findcrypt" class="headerlink" title="Findcrypt"></a>Findcrypt</h3><p>题目使用了魔改的MD5和AES，由于对AES的生疏，做题期间，我自始至终都没有察觉其存在。根据部分大佬的wp，通过IDA的插件Findcrypt可以快速定位加密算法的存在。这里附上<a href="https://bbs.pediy.com/thread-222556.htm" target="_blank" rel="noopener">安装说明</a>和<a href="https://github.com/polymorf/findcrypt-yara" target="_blank" rel="noopener">官网链接</a>。此外还需要yara环境支持。安装后可以在Edit -> Plugins -> Findcrypt进行使用。</p>
<a href="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/findcrypt.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/findcrypt.png"></a>

<p>如上图所示，经过简单分析，可以将原先的函数备注为<code>MD5_Encrypt</code>与<code>AES_Encrypt</code>，尽管这俩都经过了魔改</p>
<h3 id="MD5-Encrypt"><a href="#MD5-Encrypt" class="headerlink" title="MD5_Encrypt"></a>MD5_Encrypt</h3><p>第一个需要看的是MD5_Encrypt，图中x32dbg中显示的<code>duplicity.7B1109</code>，就是伪代码中被我们标记为<code>MD5_Encrypt</code>的函数</p>
<a href="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/md5.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/md5.png"></a>

<h4 id="参数分析"><a href="#参数分析" class="headerlink" title="参数分析"></a>参数分析</h4><ul>
<li>v8[9]：指向字符串”Enj0y_1t_4_fuuuN”</li>
<li>0x10：长度单位</li>
<li>v8[2]：<ul>
<li>执行前指向一块初始化为0的栈空间</li>
<li>执行后该栈空间更新为16字节的MD5密文</li>
</ul>
</li>
</ul>
<h3 id="AES-Encrypt"><a href="#AES-Encrypt" class="headerlink" title="AES_Encrypt"></a>AES_Encrypt</h3><p>这是一个经过魔改的<code>AES_Encrypt</code>加密，先分析参数：</p>
<a href="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/AES_parameters.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/AES_parameters.png"></a>

<h4 id="参数分析-1"><a href="#参数分析-1" class="headerlink" title="参数分析"></a>参数分析</h4><ul>
<li>v8[2]：经过MD5加密后的密文</li>
<li>0x10：经过MD5加密后的密文长度</li>
<li>v8[30]：输入的字符串，从橙色方框中的gets_s获取</li>
<li>v8[18]：经过AES加密后的输出字符串，之后通过memcmp将其与结果进行了一次比较</li>
<li>32：输入字符串的长度，橙色方框中通过strlen进行了一次过滤</li>
</ul>
<h4 id="AES算法"><a href="#AES算法" class="headerlink" title="AES算法"></a>AES算法</h4><a href="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/AES_flow.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/AES_flow.png"></a>

<p>以上为AES算法的流程图，这里不对该算法做详细介绍，但理解AES算法还是非常重要的，这里分享如下链接，简略版可参考<a href="https://bbs.pediy.com/thread-269383.htm#%E9%80%86%E5%90%91%E7%89%B9%E5%BE%81" target="_blank" rel="noopener">1</a>，详细版可以参考<a href="https://bbs.pediy.com/thread-253884.htm#msg_header_h1_3" target="_blank" rel="noopener">2</a>，综合版可以参考<a href="https://blog.csdn.net/qq_28205153/article/details/55798628" target="_blank" rel="noopener">3</a>，C语言版可以参考<a href="https://blog.csdn.net/shaosunrise/article/details/80219950" target="_blank" rel="noopener">4</a>。在对AES了解的情况下，可以找到<a href="https://github.com/lmshao/AES/" target="_blank" rel="noopener">相似项目</a>，手动导入结构体及符号，以助于伪代码的分析。</p>
<h4 id="KeyExpansion"><a href="#KeyExpansion" class="headerlink" title="KeyExpansion"></a>KeyExpansion</h4><a href="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/keyExpansion_ida.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/keyExpansion_ida.png"></a>

<p><strong>分析</strong></p>
<ol>
<li>首先是keyExpansion的代码，这部分会对MD5计算出的key进行扩展，跟进去发现，又是一个会触发的异常，这里需要patch try部分，patch后核心代码可见，这里可以参考sunfishi的<a href="https://bbs.pediy.com/thread-272772.htm" target="_blank" rel="noopener">分析文章</a>，他patch了此部分，并导入了符号与结构体，看着会更清晰。</li>
<li>这里还有很重要的一点，<strong>在<code>keyExpansion</code>进行扩展密钥时，进行了sbox中数据的交换，从而使得真正使用的S_box与原版AES的S_box有所不同，这里是题目魔改AES的一处地方，会影响后续做题。</strong></li>
</ol>
<p><strong>反思</strong></p>
<ul>
<li><p>当时做题时，这部分我并没有分析，当时并未意识到这是AES的算法，<code>keyExpansion</code>函数执行后，栈中会生成一部分数据，在之后的计算中会用到，在试过不同的输入后，发现这段栈中的数据是固定不变的，于是就拿来直接用了……</p>
</li>
<li><p>关于sbox魔改这块，我后来也发现了，不过是在最后，在已经逆完所有算法的情况下，发现计算出的结果不对。经过一个个函数的单步调试，终于发现了sbox值交换的这个操作，这里感谢我可爱的女朋友凌晨陪我调试代码！</p>
<a href="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/keyExpansion_x64.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/keyExpansion_x64.png"></a>

</li>
</ul>
<p>图中<code>duplicity.7B10BE</code>即伪代码中标识出的<code>keyExpansion</code>在执行完后，栈中就会有生成扩展密钥，具体如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">v10 = [<span class="number">0x2F65B1FF</span>, <span class="number">0x31ED86D0</span>, <span class="number">0x9A285C0F</span>, <span class="number">0x4048059D</span>,</span><br><span class="line">	   <span class="number">0x7C0EEFF6</span>, <span class="number">0x4DE36926</span>, <span class="number">0xD7CB3529</span>, <span class="number">0x978330B4</span>,</span><br><span class="line">	   <span class="number">0x920A627E</span>, <span class="number">0xDFE90B58</span>, <span class="number">0x08223E71</span>, <span class="number">0x9FA10EC5</span>,</span><br><span class="line">	   <span class="number">0xA4A1C4A5</span>, <span class="number">0x7B48CFFD</span>, <span class="number">0x736AF18C</span>, <span class="number">0xECCBFF49</span>,</span><br><span class="line">	   <span class="number">0xB3B7FF6B</span>, <span class="number">0xC8FF3096</span>, <span class="number">0xBB95C11A</span>, <span class="number">0x575E3E53</span>,</span><br><span class="line">	   <span class="number">0xFB051230</span>, <span class="number">0x33FA22A6</span>, <span class="number">0x886FE3BC</span>, <span class="number">0xDF31DDEF</span>,</span><br><span class="line">	   <span class="number">0x1CC4CDAE</span>, <span class="number">0x2F3EEF08</span>, <span class="number">0xA7510CB4</span>, <span class="number">0x7860D15B</span>,</span><br><span class="line">	   <span class="number">0x8CFAF412</span>, <span class="number">0xA3C41B1A</span>, <span class="number">0x049517AE</span>, <span class="number">0x7CF5C6F5</span>,</span><br><span class="line">	   <span class="number">0xEA4E1202</span>, <span class="number">0x498A0918</span>, <span class="number">0x4D1F1EB6</span>, <span class="number">0x31EAD843</span>,</span><br><span class="line">	   <span class="number">0x762F08C5</span>, <span class="number">0x3FA501DD</span>, <span class="number">0x72BA1F6B</span>, <span class="number">0x4350C728</span>,</span><br><span class="line">	   <span class="number">0x13E93CDF</span>, <span class="number">0x2C4C3D02</span>, <span class="number">0x5EF62269</span>, <span class="number">0x1DA6E541</span>]</span><br></pre></td></tr></tbody></table></figure></div>



<h4 id="Load-StoreStateArray"><a href="#Load-StoreStateArray" class="headerlink" title="Load/StoreStateArray"></a>Load/StoreStateArray</h4><a href="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/load_storeStateArray.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/load_storeStateArray.png"></a>

<p><strong>分析</strong></p>
<ol>
<li>从for循环可以看出，输入的32字节的字符串，会被分为2份进行操作，每次操作16字节，图中保存在变量v8中</li>
<li>这16字节，会按照字节顺序，从左到右从上到下每行4个的方式进行排列，形成一个4x4的矩阵</li>
<li><code>loadStateArray</code>会将矩阵斜对角线两侧的数据进行一个交换</li>
<li><code>storeStateArray</code>会再按照矩阵斜对角线将两侧的数据交换回来</li>
</ol>
<p><strong>还原</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意这里只是还原算法，并不是解算法，后面同理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loadStateArray</span><span class="params">(buf, orig)</span>:</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">			buf[<span class="number">4</span> * j + i] = ord(orig[<span class="number">4</span> * i + j])</span><br><span class="line">	<span class="keyword">return</span> buf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">storeStateArray</span><span class="params">(buf)</span>:</span></span><br><span class="line">	</span><br><span class="line">	res = []</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">		res.append(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">			res[i * <span class="number">4</span> + j] = buf[<span class="number">4</span> * j + i]</span><br><span class="line">	<span class="keyword">return</span> res</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>解法</strong></p>
<ol>
<li>该算法是自旋的，只需再调用一遍即可解锁</li>
</ol>
<h4 id="AddRoundKey"><a href="#AddRoundKey" class="headerlink" title="AddRoundKey"></a>AddRoundKey</h4><a href="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/addRoundKey.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/addRoundKey.png"></a>

<p><strong>分析</strong></p>
<ol>
<li>这里的参数v10，实际上就是经过<code>keyExpansion</code>扩展后的密钥，在函数开头，v10与v12指向了同一地址</li>
<li>在<code>addRoundKey</code>中，会将<strong>输入的数据与密钥按照字节异或</strong>，结果覆盖原先字符串字节处的值</li>
<li>在每轮异或运算过后，参数会指向扩展密钥的后16个字节的开始位置，这部分可以参考AES加密的<strong>密钥加法层</strong></li>
</ol>
<p><strong>还原</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addRoundKey</span><span class="params">(buf, local)</span>:</span></span><br><span class="line">	</span><br><span class="line">	res = []</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">		v5.append(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">		res.append(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">			v5 = (local[j] >> (<span class="number">8</span> * (<span class="number">3</span> - i))) & <span class="number">0xFF</span></span><br><span class="line">			res[<span class="number">4</span> * i + j] = (buf[<span class="number">4</span> * i + j]) ^ v5</span><br><span class="line">	<span class="keyword">return</span> res</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>解法</strong></p>
<ol>
<li>异或运算是对称的，因此可以再异或回去</li>
</ol>
<h4 id="SubBytes"><a href="#SubBytes" class="headerlink" title="SubBytes"></a>SubBytes</h4><a href="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/subBytes.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/subBytes.png"></a>

<p><strong>分析</strong></p>
<ol>
<li><p><code>subBytes</code>对应AES的字节代换层，字节代换层的主要功能就是让输入的数据通过S_box表完成从一个字节到另一个字节的映射，这g个S_box表是通过某种方法计算出来的</p>
</li>
<li><p>本题中，在本地偏移0x40B000处，有一个默认的S_box；但是在真正进行运算时S_box中的值被替换了（在<code>keyExpansion</code>中被替换了，然而这部分代码通过异常处理隐藏了，需要手动patch）</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原版S_box</span></span><br><span class="line"><span class="number">0040B</span>000  <span class="number">63</span> <span class="number">7</span>C <span class="number">77</span> <span class="number">7B</span> F2 <span class="number">6B</span> <span class="number">6F</span> C5  <span class="number">30</span> <span class="number">01</span> <span class="number">67</span> <span class="number">2B</span> FE D7 AB <span class="number">76</span> </span><br><span class="line"><span class="number">0040B</span>010  CA <span class="number">82</span> C9 <span class="number">7</span>D FA <span class="number">59</span> <span class="number">47</span> F0  AD D4 A2 AF <span class="number">9</span>C A4 <span class="number">72</span> C0 </span><br><span class="line"><span class="number">0040B</span>020  B7 FD <span class="number">93</span> <span class="number">26</span> <span class="number">36</span> <span class="number">3F</span> F7 CC  <span class="number">34</span> A5 E5 F1 <span class="number">71</span> D8 <span class="number">31</span> <span class="number">15</span> </span><br><span class="line"><span class="number">0040B</span>030  <span class="number">04</span> C7 <span class="number">23</span> C3 <span class="number">18</span> <span class="number">96</span> <span class="number">05</span> <span class="number">9</span>A  <span class="number">07</span> <span class="number">12</span> <span class="number">80</span> E2 EB <span class="number">27</span> B2 <span class="number">75</span> </span><br><span class="line"><span class="number">0040B</span>040  <span class="number">09</span> <span class="number">83</span> <span class="number">2</span>C <span class="number">1</span>A <span class="number">1B</span> <span class="number">6</span>E <span class="number">5</span>A A0  <span class="number">52</span> <span class="number">3B</span> D6 B3 <span class="number">29</span> E3 <span class="number">2F</span> <span class="number">84</span> </span><br><span class="line"><span class="number">0040B</span>050  <span class="number">53</span> D1 <span class="number">00</span> ED <span class="number">20</span> FC B1 <span class="number">5B</span>  <span class="number">6</span>A CB BE <span class="number">39</span> <span class="number">4</span>A <span class="number">4</span>C <span class="number">58</span> CF </span><br><span class="line"><span class="number">0040B</span>060  D0 EF AA FB <span class="number">43</span> <span class="number">4</span>D <span class="number">33</span> <span class="number">85</span>  <span class="number">45</span> F9 <span class="number">02</span> <span class="number">7F</span> <span class="number">50</span> <span class="number">3</span>C <span class="number">9F</span> A8 </span><br><span class="line"><span class="number">0040B</span>070  <span class="number">51</span> A3 <span class="number">40</span> <span class="number">8F</span> <span class="number">92</span> <span class="number">9</span>D <span class="number">38</span> F5  BC B6 DA <span class="number">21</span> <span class="number">10</span> FF F3 D2 </span><br><span class="line"><span class="number">0040B</span>080  CD <span class="number">0</span>C <span class="number">13</span> EC <span class="number">5F</span> <span class="number">97</span> <span class="number">44</span> <span class="number">17</span>  C4 A7 <span class="number">7</span>E <span class="number">3</span>D <span class="number">64</span> <span class="number">5</span>D <span class="number">19</span> <span class="number">73</span> </span><br><span class="line"><span class="number">0040B</span>090  <span class="number">60</span> <span class="number">81</span> <span class="number">4F</span> DC <span class="number">22</span> <span class="number">2</span>A <span class="number">90</span> <span class="number">88</span>  <span class="number">46</span> EE B8 <span class="number">14</span> DE <span class="number">5</span>E <span class="number">0B</span> DB </span><br><span class="line"><span class="number">0040B</span>0A0  E0 <span class="number">32</span> <span class="number">3</span>A <span class="number">0</span>A <span class="number">49</span> <span class="number">06</span> <span class="number">24</span> <span class="number">5</span>C  C2 D3 AC <span class="number">62</span> <span class="number">91</span> <span class="number">95</span> E4 <span class="number">79</span> </span><br><span class="line"><span class="number">0040B</span>0B0  E7 C8 <span class="number">37</span> <span class="number">6</span>D <span class="number">8</span>D D5 <span class="number">4</span>E A9  <span class="number">6</span>C <span class="number">56</span> F4 EA <span class="number">65</span> <span class="number">7</span>A AE <span class="number">08</span> </span><br><span class="line"><span class="number">0040B</span>0C0  BA <span class="number">78</span> <span class="number">25</span> <span class="number">2</span>E <span class="number">1</span>C A6 B4 C6  E8 DD <span class="number">74</span> <span class="number">1F</span> <span class="number">4B</span> BD <span class="number">8B</span> <span class="number">8</span>A </span><br><span class="line"><span class="number">0040B</span>0D0  <span class="number">70</span> <span class="number">3</span>E B5 <span class="number">66</span> <span class="number">48</span> <span class="number">03</span> F6 <span class="number">0</span>E  <span class="number">61</span> <span class="number">35</span> <span class="number">57</span> B9 <span class="number">86</span> C1 <span class="number">1</span>D <span class="number">9</span>E </span><br><span class="line"><span class="number">0040B</span>0E0  E1 F8 <span class="number">98</span> <span class="number">11</span> <span class="number">69</span> D9 <span class="number">8</span>E <span class="number">94</span>  <span class="number">9B</span> <span class="number">1</span>E <span class="number">87</span> E9 CE <span class="number">55</span> <span class="number">28</span> DF </span><br><span class="line"><span class="number">0040B</span>0F0  <span class="number">8</span>C A1 <span class="number">89</span> <span class="number">0</span>D BF E6 <span class="number">42</span> <span class="number">68</span>  <span class="number">41</span> <span class="number">99</span> <span class="number">2</span>D <span class="number">0F</span> B0 <span class="number">54</span> BB <span class="number">16</span> </span><br><span class="line">                                                                           </span><br><span class="line"><span class="comment">// 实际使用的S_box                                                                       </span></span><br><span class="line"><span class="number">0040B</span>000  <span class="number">63</span> <span class="number">7</span>C <span class="number">77</span> <span class="number">7B</span> F2 <span class="number">6B</span> <span class="number">6F</span> C5 <span class="number">30</span> <span class="number">01</span> <span class="number">67</span> <span class="number">2B</span> FE D7 AB <span class="number">76</span> </span><br><span class="line"><span class="number">0040B</span>010  CA <span class="number">82</span> C9 <span class="number">7</span>D FA <span class="number">59</span> <span class="number">47</span> F0 AD D4 A2 AF <span class="number">9</span>C A4 <span class="number">72</span> C0 </span><br><span class="line"><span class="number">0040B</span>020  B7 FD <span class="number">93</span> <span class="number">26</span> <span class="number">36</span> <span class="number">3F</span> F7 CC <span class="number">34</span> A5 E5 F1 <span class="number">71</span> D8 <span class="number">31</span> <span class="number">15</span> </span><br><span class="line"><span class="number">0040B</span>030  <span class="number">04</span> C7 <span class="number">23</span> C3 <span class="number">18</span> <span class="number">96</span> <span class="number">05</span> <span class="number">9</span>A <span class="number">07</span> <span class="number">12</span> <span class="number">80</span> E2 EB <span class="number">27</span> B2 <span class="number">75</span> </span><br><span class="line"><span class="number">0040B</span>040  <span class="number">09</span> <span class="number">83</span> <span class="number">2</span>C <span class="number">1</span>A <span class="number">1B</span> <span class="number">6</span>E <span class="number">5</span>A A0 <span class="number">52</span> <span class="number">3B</span> D6 B3 <span class="number">29</span> E3 <span class="number">2F</span> <span class="number">84</span> </span><br><span class="line"><span class="number">0040B</span>050  <span class="number">53</span> D1 <span class="number">00</span> ED <span class="number">20</span> FC B1 <span class="number">5B</span> <span class="number">6</span>A CB BE <span class="number">39</span> <span class="number">4</span>A <span class="number">4</span>C <span class="number">58</span> CF </span><br><span class="line"><span class="number">0040B</span>060  D0 EF AA FB <span class="number">43</span> <span class="number">4</span>D <span class="number">33</span> <span class="number">85</span> <span class="number">45</span> F9 <span class="number">02</span> <span class="number">7F</span> <span class="number">50</span> <span class="number">3</span>C <span class="number">9F</span> A8 </span><br><span class="line"><span class="number">0040B</span>070  <span class="number">51</span> <span class="number">0</span>A <span class="number">40</span> <span class="number">8F</span> <span class="number">92</span> <span class="number">9</span>D <span class="number">38</span> F5 BC B6 DA <span class="number">21</span> <span class="number">10</span> FF F3 D2 </span><br><span class="line"><span class="number">0040B</span>080  CD <span class="number">0</span>C <span class="number">13</span> EC <span class="number">5F</span> <span class="number">97</span> <span class="number">44</span> <span class="number">17</span> C4 A7 <span class="number">7</span>E <span class="number">3</span>D <span class="number">64</span> <span class="number">5</span>D <span class="number">19</span> <span class="number">73</span> </span><br><span class="line"><span class="number">0040B</span>090  <span class="number">60</span> <span class="number">81</span> <span class="number">4F</span> DC <span class="number">22</span> <span class="number">2</span>A <span class="number">90</span> <span class="number">88</span> <span class="number">46</span> EE B8 <span class="number">14</span> DE <span class="number">5</span>E <span class="number">0B</span> DB </span><br><span class="line"><span class="number">0040B</span>0A0  E0 <span class="number">32</span> <span class="number">3</span>A A3 <span class="number">49</span> <span class="number">06</span> <span class="number">24</span> <span class="number">5</span>C C2 D3 AC <span class="number">62</span> <span class="number">91</span> <span class="number">95</span> E4 <span class="number">79</span> </span><br><span class="line"><span class="number">0040B</span>0B0  E7 C8 <span class="number">37</span> <span class="number">6</span>D <span class="number">8</span>D D5 <span class="number">4</span>E A9 <span class="number">6</span>C <span class="number">56</span> F4 EA <span class="number">65</span> <span class="number">7</span>A AE <span class="number">08</span> </span><br><span class="line"><span class="number">0040B</span>0C0  BA <span class="number">78</span> <span class="number">25</span> <span class="number">2</span>E <span class="number">1</span>C A6 B4 C6 E8 DD <span class="number">74</span> <span class="number">1F</span> <span class="number">4B</span> BD <span class="number">8B</span> <span class="number">8</span>A </span><br><span class="line"><span class="number">0040B</span>0D0  <span class="number">70</span> <span class="number">3</span>E B5 <span class="number">66</span> <span class="number">48</span> <span class="number">03</span> F6 <span class="number">0</span>E <span class="number">61</span> <span class="number">35</span> <span class="number">57</span> B9 <span class="number">86</span> C1 <span class="number">1</span>D <span class="number">9</span>E </span><br><span class="line"><span class="number">0040B</span>0E0  E1 F8 <span class="number">98</span> <span class="number">11</span> <span class="number">69</span> D9 <span class="number">8</span>E <span class="number">94</span> <span class="number">9B</span> <span class="number">1</span>E <span class="number">87</span> E9 CE <span class="number">55</span> <span class="number">28</span> DF </span><br><span class="line"><span class="number">0040B</span>0F0  <span class="number">8</span>C A1 <span class="number">89</span> <span class="number">0</span>D BF E6 <span class="number">42</span> <span class="number">68</span> <span class="number">41</span> <span class="number">99</span> <span class="number">2</span>D <span class="number">0F</span> B0 <span class="number">54</span> BB <span class="number">16</span></span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>两个S_box不同之处在于地址0x0040B071（”0xA3”）与0x0040B0A3处的值（”0x0A”）交换了</p>
</li>
<li><p>由于交换是在<code>keyExpansion</code>中进行的，所以执行到此处时S_box已确定，可以直接从内存中dump出来用</p>
</li>
</ol>
<p><strong>还原</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">subBytes</span><span class="params">(buf)</span>:</span></span><br><span class="line">	</span><br><span class="line">	res = []</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">		res.append(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">			res[<span class="number">4</span> * i + j] = byte_40B000[buf[<span class="number">4</span> * i + j]]</span><br><span class="line">	<span class="keyword">return</span> res</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>解法</strong></p>
<ol>
<li>拥有密钥（MD5生成的16字节密钥）的情况下解AES，通常需要逆S_box盒，这里S_box修改了，逆S_box盒也要相应修改</li>
<li>直接在S_box找到对应的值的下标（0<x<0xff），得到代换前的值< li>
</x<0xff），得到代换前的值<></li></ol>
<h4 id="ShiftRows"><a href="#ShiftRows" class="headerlink" title="ShiftRows"></a>ShiftRows</h4><a href="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/patchExceptionHandler.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/patchExceptionHandler.png"></a>

<p>这一块代码不能F5的，会显示错误<code>sp-analysis failed</code>，文末也推荐了几篇解决不能F5的文章，所以我给它patch了（我觉得这算是作者的一个提示，如果允许F5，然后还是隐藏在异常处理里的话，那我可能就不会去patch了）。这里我将原先的<code>int 0x8B</code>指令改掉了，不让它触发异常，直接跳转到异常处理函数里面，这样就可以保存栈平衡，就能够F5直接看到程序代码逻辑了。</p>
<a href="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/shiftRows.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/shiftRows.png"></a>

<p><strong>分析</strong></p>
<ol>
<li><code>shiftRows</code>对应AES的行位移操作，这里作者进行了魔改，将4x4矩阵的每行依次<strong>循环右移</strong>0/1/2/3个字节</li>
<li>在原版的AES操作中，是依次<strong>循环左移</strong>0/1/2/3个字节</li>
</ol>
<p><strong>还原</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shiftRows</span><span class="params">(buf)</span>:</span></span><br><span class="line">	</span><br><span class="line">	res = []</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">		res.append(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		res[<span class="number">4</span>*i:<span class="number">5</span>*i] = buf[<span class="number">4</span>*i+<span class="number">4</span>-i:<span class="number">4</span>*i+<span class="number">4</span>]</span><br><span class="line">		res[<span class="number">5</span>*i:<span class="number">4</span>*i+<span class="number">4</span>] = buf[<span class="number">4</span>*i:<span class="number">4</span>*i+<span class="number">4</span>-i]</span><br><span class="line">	<span class="keyword">return</span> res</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>解法</strong></p>
<ol>
<li>解法很简单，依次循环左移即可</li>
</ol>
<h4 id="MixColumns"><a href="#MixColumns" class="headerlink" title="MixColumns"></a>MixColumns</h4><a href="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/mixColumns.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" data-src="/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/mixColumns.png"></a>

<p><strong>分析</strong></p>
<ol>
<li>列混淆，对应列混淆子层，是AES算法中最为复杂的部分</li>
<li>需要将输入的4x4矩阵左乘一个给定的4x4矩阵。而它们之间的加法、乘法都在扩展域GF(2^8)中进行</li>
</ol>
<p><strong>还原</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mixColumns</span><span class="params">(buf)</span>:</span></span><br><span class="line">	</span><br><span class="line">	v9 = []</span><br><span class="line">	res = []</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">		res.append(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">44</span>):</span><br><span class="line">		v9.append(<span class="number">0xCC</span>)</span><br><span class="line">	v9[<span class="number">0</span>] = <span class="number">2</span>;</span><br><span class="line">	v9[<span class="number">1</span>] = <span class="number">3</span>;</span><br><span class="line">	v9[<span class="number">2</span>] = <span class="number">1</span>;</span><br><span class="line">	v9[<span class="number">3</span>] = <span class="number">1</span>;</span><br><span class="line">	v9[<span class="number">4</span>] = <span class="number">1</span>;</span><br><span class="line">	v9[<span class="number">5</span>] = <span class="number">2</span>;</span><br><span class="line">	v9[<span class="number">6</span>] = <span class="number">3</span>;</span><br><span class="line">	v9[<span class="number">7</span>] = <span class="number">1</span>;</span><br><span class="line">	v9[<span class="number">8</span>] = <span class="number">1</span>;</span><br><span class="line">	v9[<span class="number">9</span>] = <span class="number">1</span>;</span><br><span class="line">	v9[<span class="number">10</span>] = <span class="number">2</span>;</span><br><span class="line">	v9[<span class="number">11</span>] = <span class="number">3</span>;</span><br><span class="line">	v9[<span class="number">12</span>] = <span class="number">3</span>;</span><br><span class="line">	v9[<span class="number">13</span>] = <span class="number">1</span>;</span><br><span class="line">	v9[<span class="number">14</span>] = <span class="number">1</span>;</span><br><span class="line">	v9[<span class="number">15</span>] = <span class="number">2</span>;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">			v9[<span class="number">4</span> * i + <span class="number">24</span> + j] = buf[<span class="number">4</span> * i + j]</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">for</span> m <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">			tmp = sub_401118(v9[<span class="number">4</span> * k], v9[m + <span class="number">24</span>])</span><br><span class="line">			v1 = tmp</span><br><span class="line">			tmp = sub_401118(v9[<span class="number">4</span> * k + <span class="number">1</span>], v9[m + <span class="number">28</span>])</span><br><span class="line">			v2 = tmp ^ v1</span><br><span class="line">			tmp = sub_401118(v9[<span class="number">4</span> * k + <span class="number">2</span>], v9[m + <span class="number">32</span>])</span><br><span class="line">			v3 = tmp ^ v2</span><br><span class="line">			tmp = sub_401118(v9[<span class="number">4</span> * k + <span class="number">3</span>], v9[m + <span class="number">36</span>])</span><br><span class="line">			v4 = tmp ^ v3</span><br><span class="line">			res[<span class="number">4</span> * k + m] = v4</span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_401118</span><span class="params">(a1, a2)</span>:</span></span><br><span class="line">	v5 = <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">		<span class="keyword">if</span> a1 & <span class="number">1</span> != <span class="number">0</span>:</span><br><span class="line">			v5 = (a2 ^ v5) & <span class="number">0xFF</span></span><br><span class="line">		v3 = a2 & <span class="number">0x80</span></span><br><span class="line">		a2 = (a2 * <span class="number">2</span>) & <span class="number">0xFF</span></span><br><span class="line">		<span class="keyword">if</span> v3 != <span class="number">0</span>:</span><br><span class="line">			a2 = (a2 ^ <span class="number">0x1B</span>) & <span class="number">0xFF</span></span><br><span class="line">		a1 = (a1 >> <span class="number">1</span>) & <span class="number">0xFF</span></span><br><span class="line">	<span class="keyword">return</span> v5</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>解法</strong></p>
<ol>
<li><p><a href="https://bbs.pediy.com/thread-272774.htm" target="_blank" rel="noopener">wx_孤城</a>发现调用<code>mixColumns</code>自旋3下即可解密</p>
</li>
<li><p>通过<strong>逆列混合矩阵</strong>进行解密，这部分可以参考<a href="https://bbs.pediy.com/thread-272787.htm#msg_header_h2_0" target="_blank" rel="noopener">堂前燕</a>的文章</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> deColM[<span class="number">4</span>][<span class="number">4</span>] = { </span><br><span class="line">    <span class="number">0xe</span>, <span class="number">0xb</span>, <span class="number">0xd</span>, <span class="number">0x9</span>,</span><br><span class="line">    <span class="number">0x9</span>, <span class="number">0xe</span>, <span class="number">0xb</span>, <span class="number">0xd</span>,</span><br><span class="line">    <span class="number">0xd</span>, <span class="number">0x9</span>, <span class="number">0xe</span>, <span class="number">0xb</span>,</span><br><span class="line">    <span class="number">0xb</span>, <span class="number">0xd</span>, <span class="number">0x9</span>, <span class="number">0xe</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure></div>



</li>
</ol>
<h2 id="失败的还原"><a href="#失败的还原" class="headerlink" title="失败的还原"></a>失败的还原</h2><p>虽然很失败，但还是靠着一点点单步，还原了完整的加密算法，不甘心就这样浪费心血了，所以博客里附上我还原的完整代码</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">v10 = [<span class="number">0x2F65B1FF</span>, <span class="number">0x31ED86D0</span>, <span class="number">0x9A285C0F</span>, <span class="number">0x4048059D</span>,</span><br><span class="line">	   <span class="number">0x7C0EEFF6</span>, <span class="number">0x4DE36926</span>, <span class="number">0xD7CB3529</span>, <span class="number">0x978330B4</span>,</span><br><span class="line">	   <span class="number">0x920A627E</span>, <span class="number">0xDFE90B58</span>, <span class="number">0x08223E71</span>, <span class="number">0x9FA10EC5</span>,</span><br><span class="line">	   <span class="number">0xA4A1C4A5</span>, <span class="number">0x7B48CFFD</span>, <span class="number">0x736AF18C</span>, <span class="number">0xECCBFF49</span>,</span><br><span class="line">	   <span class="number">0xB3B7FF6B</span>, <span class="number">0xC8FF3096</span>, <span class="number">0xBB95C11A</span>, <span class="number">0x575E3E53</span>,</span><br><span class="line">	   <span class="number">0xFB051230</span>, <span class="number">0x33FA22A6</span>, <span class="number">0x886FE3BC</span>, <span class="number">0xDF31DDEF</span>,</span><br><span class="line">	   <span class="number">0x1CC4CDAE</span>, <span class="number">0x2F3EEF08</span>, <span class="number">0xA7510CB4</span>, <span class="number">0x7860D15B</span>,</span><br><span class="line">	   <span class="number">0x8CFAF412</span>, <span class="number">0xA3C41B1A</span>, <span class="number">0x049517AE</span>, <span class="number">0x7CF5C6F5</span>,</span><br><span class="line">	   <span class="number">0xEA4E1202</span>, <span class="number">0x498A0918</span>, <span class="number">0x4D1F1EB6</span>, <span class="number">0x31EAD843</span>,</span><br><span class="line">	   <span class="number">0x762F08C5</span>, <span class="number">0x3FA501DD</span>, <span class="number">0x72BA1F6B</span>, <span class="number">0x4350C728</span>,</span><br><span class="line">	   <span class="number">0x13E93CDF</span>, <span class="number">0x2C4C3D02</span>, <span class="number">0x5EF62269</span>, <span class="number">0x1DA6E541</span>]</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">byte_40B000 = [</span><br><span class="line">	<span class="number">0x63</span>, <span class="number">0x7C</span>, <span class="number">0x77</span>, <span class="number">0x7B</span>, <span class="number">0xF2</span>, <span class="number">0x6B</span>, <span class="number">0x6F</span>, <span class="number">0xC5</span>, <span class="number">0x30</span>, <span class="number">0x01</span>, <span class="number">0x67</span>, <span class="number">0x2B</span>, <span class="number">0xFE</span>, <span class="number">0xD7</span>, <span class="number">0xAB</span>, <span class="number">0x76</span>,</span><br><span class="line">	<span class="number">0xCA</span>, <span class="number">0x82</span>, <span class="number">0xC9</span>, <span class="number">0x7D</span>, <span class="number">0xFA</span>, <span class="number">0x59</span>, <span class="number">0x47</span>, <span class="number">0xF0</span>, <span class="number">0xAD</span>, <span class="number">0xD4</span>, <span class="number">0xA2</span>, <span class="number">0xAF</span>, <span class="number">0x9C</span>, <span class="number">0xA4</span>, <span class="number">0x72</span>, <span class="number">0xC0</span>,</span><br><span class="line">	<span class="number">0xB7</span>, <span class="number">0xFD</span>, <span class="number">0x93</span>, <span class="number">0x26</span>, <span class="number">0x36</span>, <span class="number">0x3F</span>, <span class="number">0xF7</span>, <span class="number">0xCC</span>, <span class="number">0x34</span>, <span class="number">0xA5</span>, <span class="number">0xE5</span>, <span class="number">0xF1</span>, <span class="number">0x71</span>, <span class="number">0xD8</span>, <span class="number">0x31</span>, <span class="number">0x15</span>,</span><br><span class="line">	<span class="number">0x04</span>, <span class="number">0xC7</span>, <span class="number">0x23</span>, <span class="number">0xC3</span>, <span class="number">0x18</span>, <span class="number">0x96</span>, <span class="number">0x05</span>, <span class="number">0x9A</span>, <span class="number">0x07</span>, <span class="number">0x12</span>, <span class="number">0x80</span>, <span class="number">0xE2</span>, <span class="number">0xEB</span>, <span class="number">0x27</span>, <span class="number">0xB2</span>, <span class="number">0x75</span>,</span><br><span class="line">	<span class="number">0x09</span>, <span class="number">0x83</span>, <span class="number">0x2C</span>, <span class="number">0x1A</span>, <span class="number">0x1B</span>, <span class="number">0x6E</span>, <span class="number">0x5A</span>, <span class="number">0xA0</span>, <span class="number">0x52</span>, <span class="number">0x3B</span>, <span class="number">0xD6</span>, <span class="number">0xB3</span>, <span class="number">0x29</span>, <span class="number">0xE3</span>, <span class="number">0x2F</span>, <span class="number">0x84</span>,</span><br><span class="line">	<span class="number">0x53</span>, <span class="number">0xD1</span>, <span class="number">0x00</span>, <span class="number">0xED</span>, <span class="number">0x20</span>, <span class="number">0xFC</span>, <span class="number">0xB1</span>, <span class="number">0x5B</span>, <span class="number">0x6A</span>, <span class="number">0xCB</span>, <span class="number">0xBE</span>, <span class="number">0x39</span>, <span class="number">0x4A</span>, <span class="number">0x4C</span>, <span class="number">0x58</span>, <span class="number">0xCF</span>,</span><br><span class="line">	<span class="number">0xD0</span>, <span class="number">0xEF</span>, <span class="number">0xAA</span>, <span class="number">0xFB</span>, <span class="number">0x43</span>, <span class="number">0x4D</span>, <span class="number">0x33</span>, <span class="number">0x85</span>, <span class="number">0x45</span>, <span class="number">0xF9</span>, <span class="number">0x02</span>, <span class="number">0x7F</span>, <span class="number">0x50</span>, <span class="number">0x3C</span>, <span class="number">0x9F</span>, <span class="number">0xA8</span>,</span><br><span class="line">	<span class="number">0x51</span>, <span class="number">0x0A</span>, <span class="number">0x40</span>, <span class="number">0x8F</span>, <span class="number">0x92</span>, <span class="number">0x9D</span>, <span class="number">0x38</span>, <span class="number">0xF5</span>, <span class="number">0xBC</span>, <span class="number">0xB6</span>, <span class="number">0xDA</span>, <span class="number">0x21</span>, <span class="number">0x10</span>, <span class="number">0xFF</span>, <span class="number">0xF3</span>, <span class="number">0xD2</span>,</span><br><span class="line">	<span class="number">0xCD</span>, <span class="number">0x0C</span>, <span class="number">0x13</span>, <span class="number">0xEC</span>, <span class="number">0x5F</span>, <span class="number">0x97</span>, <span class="number">0x44</span>, <span class="number">0x17</span>, <span class="number">0xC4</span>, <span class="number">0xA7</span>, <span class="number">0x7E</span>, <span class="number">0x3D</span>, <span class="number">0x64</span>, <span class="number">0x5D</span>, <span class="number">0x19</span>, <span class="number">0x73</span>,</span><br><span class="line">	<span class="number">0x60</span>, <span class="number">0x81</span>, <span class="number">0x4F</span>, <span class="number">0xDC</span>, <span class="number">0x22</span>, <span class="number">0x2A</span>, <span class="number">0x90</span>, <span class="number">0x88</span>, <span class="number">0x46</span>, <span class="number">0xEE</span>, <span class="number">0xB8</span>, <span class="number">0x14</span>, <span class="number">0xDE</span>, <span class="number">0x5E</span>, <span class="number">0x0B</span>, <span class="number">0xDB</span>,</span><br><span class="line">	<span class="number">0xE0</span>, <span class="number">0x32</span>, <span class="number">0x3A</span>, <span class="number">0xA3</span>, <span class="number">0x49</span>, <span class="number">0x06</span>, <span class="number">0x24</span>, <span class="number">0x5C</span>, <span class="number">0xC2</span>, <span class="number">0xD3</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>, <span class="number">0x91</span>, <span class="number">0x95</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>,</span><br><span class="line">	<span class="number">0xE7</span>, <span class="number">0xC8</span>, <span class="number">0x37</span>, <span class="number">0x6D</span>, <span class="number">0x8D</span>, <span class="number">0xD5</span>, <span class="number">0x4E</span>, <span class="number">0xA9</span>, <span class="number">0x6C</span>, <span class="number">0x56</span>, <span class="number">0xF4</span>, <span class="number">0xEA</span>, <span class="number">0x65</span>, <span class="number">0x7A</span>, <span class="number">0xAE</span>, <span class="number">0x08</span>,</span><br><span class="line">	<span class="number">0xBA</span>, <span class="number">0x78</span>, <span class="number">0x25</span>, <span class="number">0x2E</span>, <span class="number">0x1C</span>, <span class="number">0xA6</span>, <span class="number">0xB4</span>, <span class="number">0xC6</span>, <span class="number">0xE8</span>, <span class="number">0xDD</span>, <span class="number">0x74</span>, <span class="number">0x1F</span>, <span class="number">0x4B</span>, <span class="number">0xBD</span>, <span class="number">0x8B</span>, <span class="number">0x8A</span>,</span><br><span class="line">	<span class="number">0x70</span>, <span class="number">0x3E</span>, <span class="number">0xB5</span>, <span class="number">0x66</span>, <span class="number">0x48</span>, <span class="number">0x03</span>, <span class="number">0xF6</span>, <span class="number">0x0E</span>, <span class="number">0x61</span>, <span class="number">0x35</span>, <span class="number">0x57</span>, <span class="number">0xB9</span>, <span class="number">0x86</span>, <span class="number">0xC1</span>, <span class="number">0x1D</span>, <span class="number">0x9E</span>,</span><br><span class="line">	<span class="number">0xE1</span>, <span class="number">0xF8</span>, <span class="number">0x98</span>, <span class="number">0x11</span>, <span class="number">0x69</span>, <span class="number">0xD9</span>, <span class="number">0x8E</span>, <span class="number">0x94</span>, <span class="number">0x9B</span>, <span class="number">0x1E</span>, <span class="number">0x87</span>, <span class="number">0xE9</span>, <span class="number">0xCE</span>, <span class="number">0x55</span>, <span class="number">0x28</span>, <span class="number">0xDF</span>,</span><br><span class="line">	<span class="number">0x8C</span>, <span class="number">0xA1</span>, <span class="number">0x89</span>, <span class="number">0x0D</span>, <span class="number">0xBF</span>, <span class="number">0xE6</span>, <span class="number">0x42</span>, <span class="number">0x68</span>, <span class="number">0x41</span>, <span class="number">0x99</span>, <span class="number">0x2D</span>, <span class="number">0x0F</span>, <span class="number">0xB0</span>, <span class="number">0x54</span>, <span class="number">0xBB</span>, <span class="number">0x16</span>]</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_402070</span><span class="params">(s)</span>:</span></span><br><span class="line">	</span><br><span class="line">	v8 = []</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">		v8.append(<span class="number">0</span>)</span><br><span class="line">	v8 = sub_401145(v8, s)</span><br><span class="line">	<span class="comment">#for i in range(4):</span></span><br><span class="line">	<span class="comment">#	print(hex(v8[4 * i]), hex(v8[4 * i + 1]), hex(v8[4 * i + 2]), hex(v8[4 * i + 3]))</span></span><br><span class="line">	<span class="comment">#print()</span></span><br><span class="line"></span><br><span class="line">	v8 = sub_401186(v8,  v10[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">		</span><br><span class="line">		<span class="comment"># Get Value From Byte_40B000</span></span><br><span class="line">		v8 = sub_401172(v8)</span><br><span class="line"></span><br><span class="line">		<span class="comment"># ROR</span></span><br><span class="line">		v8 = sub_40122B(v8)</span><br><span class="line"></span><br><span class="line">		v8 = sub_40100F(v8)</span><br><span class="line"></span><br><span class="line">		<span class="comment"># Xor Local</span></span><br><span class="line">		v8 = sub_401186(v8, v10[<span class="number">4</span>+j*<span class="number">4</span>:<span class="number">8</span>+j*<span class="number">4</span>])</span><br><span class="line">	</span><br><span class="line">	v8 = sub_401172(v8)</span><br><span class="line">	</span><br><span class="line">	v8 = sub_40122B(v8)</span><br><span class="line">	</span><br><span class="line">	len_v10 = len(v10)</span><br><span class="line">	v8 = sub_401186(v8, v10[len_v10<span class="number">-4</span>:len_v10])</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		print(hex(v8[<span class="number">4</span> * i]), hex(v8[<span class="number">4</span> * i + <span class="number">1</span>]), hex(v8[<span class="number">4</span> * i + <span class="number">2</span>]), hex(v8[<span class="number">4</span> * i + <span class="number">3</span>]))</span><br><span class="line">	print()</span><br><span class="line"></span><br><span class="line">	v8 = sub_40125D(v8)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> v8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_40125D</span><span class="params">(buf)</span>:</span></span><br><span class="line">	</span><br><span class="line">	res = []</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">		res.append(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">			res[i * <span class="number">4</span> + j] = buf[<span class="number">4</span> * j + i]</span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_401145</span><span class="params">(buf, orig)</span>:</span></span><br><span class="line">	</span><br><span class="line">	k = <span class="number">0</span></span><br><span class="line">	<span class="comment">#print('orig', 'now', 'value')</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">			buf[<span class="number">4</span> * j + i] = ord(orig[<span class="number">4</span> * i + j])</span><br><span class="line">			k = k + <span class="number">1</span></span><br><span class="line">			</span><br><span class="line">			<span class="comment">#print(4 * i + j, 4 * j + i, hex(ord(orig[4 * i + j])))</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> buf</span><br><span class="line">		</span><br><span class="line">			</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_401186</span><span class="params">(buf, local)</span>:</span></span><br><span class="line">	</span><br><span class="line">	v5 = []</span><br><span class="line">	res = []</span><br><span class="line"></span><br><span class="line">	<span class="comment">#print()</span></span><br><span class="line">	<span class="comment">#print('s', 'orig', 'now')</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">		v5.append(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">		res.append(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">			v5 = (local[j] >> (<span class="number">8</span> * (<span class="number">3</span> - i))) & <span class="number">0xFF</span></span><br><span class="line">			res[<span class="number">4</span> * i + j] = (buf[<span class="number">4</span> * i + j]) ^ v5</span><br><span class="line">			<span class="comment">#print(4 * i + j, hex(local[j]), hex(local[j] >> (8 * (3 - i))), hex(v5), hex(res[4 * i + j]))</span></span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_401172</span><span class="params">(buf)</span>:</span></span><br><span class="line">	</span><br><span class="line">	res = []</span><br><span class="line">	<span class="comment">#print()</span></span><br><span class="line">	<span class="comment">#print('s', 'orig', 'now')</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">		res.append(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">			res[<span class="number">4</span> * i + j] = byte_40B000[buf[<span class="number">4</span> * i + j]]</span><br><span class="line">			<span class="comment">#print(4 * i + j, hex(buf[4 * i + j]), hex(res[4 * i + j]))</span></span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROR</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_40122B</span><span class="params">(buf)</span>:</span></span><br><span class="line">	</span><br><span class="line">	res = []</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">		res.append(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		res[<span class="number">4</span>*i:<span class="number">5</span>*i] = buf[<span class="number">4</span>*i+<span class="number">4</span>-i:<span class="number">4</span>*i+<span class="number">4</span>]</span><br><span class="line">		res[<span class="number">5</span>*i:<span class="number">4</span>*i+<span class="number">4</span>] = buf[<span class="number">4</span>*i:<span class="number">4</span>*i+<span class="number">4</span>-i]</span><br><span class="line">	<span class="comment">#print()</span></span><br><span class="line">	<span class="comment">#print('after ror:')</span></span><br><span class="line">	<span class="comment">#for i in range(4):</span></span><br><span class="line">	<span class="comment">#	print(hex(res[4 * i]), hex(res[4 * i + 1]), hex(res[4 * i + 2]), hex(res[4 * i + 3]))</span></span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_40100F</span><span class="params">(buf)</span>:</span></span><br><span class="line">	</span><br><span class="line">	v9 = []</span><br><span class="line">	res = []</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">		res.append(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">44</span>):</span><br><span class="line">		v9.append(<span class="number">0xCC</span>)</span><br><span class="line">	v9[<span class="number">0</span>] = <span class="number">2</span>;</span><br><span class="line">	v9[<span class="number">1</span>] = <span class="number">3</span>;</span><br><span class="line">	v9[<span class="number">2</span>] = <span class="number">1</span>;</span><br><span class="line">	v9[<span class="number">3</span>] = <span class="number">1</span>;</span><br><span class="line">	v9[<span class="number">4</span>] = <span class="number">1</span>;</span><br><span class="line">	v9[<span class="number">5</span>] = <span class="number">2</span>;</span><br><span class="line">	v9[<span class="number">6</span>] = <span class="number">3</span>;</span><br><span class="line">	v9[<span class="number">7</span>] = <span class="number">1</span>;</span><br><span class="line">	v9[<span class="number">8</span>] = <span class="number">1</span>;</span><br><span class="line">	v9[<span class="number">9</span>] = <span class="number">1</span>;</span><br><span class="line">	v9[<span class="number">10</span>] = <span class="number">2</span>;</span><br><span class="line">	v9[<span class="number">11</span>] = <span class="number">3</span>;</span><br><span class="line">	v9[<span class="number">12</span>] = <span class="number">3</span>;</span><br><span class="line">	v9[<span class="number">13</span>] = <span class="number">1</span>;</span><br><span class="line">	v9[<span class="number">14</span>] = <span class="number">1</span>;</span><br><span class="line">	v9[<span class="number">15</span>] = <span class="number">2</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">			v9[<span class="number">4</span> * i + <span class="number">24</span> + j] = buf[<span class="number">4</span> * i + j]</span><br><span class="line">	<span class="comment">#for x in v9:</span></span><br><span class="line">	<span class="comment">#	print(hex(x))</span></span><br><span class="line">	<span class="comment">#print()</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">for</span> m <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">			tmp = sub_401118(v9[<span class="number">4</span> * k], v9[m + <span class="number">24</span>])</span><br><span class="line">			v1 = tmp</span><br><span class="line">			tmp = sub_401118(v9[<span class="number">4</span> * k + <span class="number">1</span>], v9[m + <span class="number">28</span>])</span><br><span class="line">			v2 = tmp ^ v1</span><br><span class="line">			tmp = sub_401118(v9[<span class="number">4</span> * k + <span class="number">2</span>], v9[m + <span class="number">32</span>])</span><br><span class="line">			v3 = tmp ^ v2</span><br><span class="line">			tmp = sub_401118(v9[<span class="number">4</span> * k + <span class="number">3</span>], v9[m + <span class="number">36</span>])</span><br><span class="line">			v4 = tmp ^ v3</span><br><span class="line">			res[<span class="number">4</span> * k + m] = v4</span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_401118</span><span class="params">(a1, a2)</span>:</span></span><br><span class="line">	v5 = <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">		<span class="keyword">if</span> a1 & <span class="number">1</span> != <span class="number">0</span>:</span><br><span class="line">			v5 = (a2 ^ v5) & <span class="number">0xFF</span></span><br><span class="line">		v3 = a2 & <span class="number">0x80</span></span><br><span class="line">		a2 = (a2 * <span class="number">2</span>) & <span class="number">0xFF</span></span><br><span class="line">		<span class="keyword">if</span> v3 != <span class="number">0</span>:</span><br><span class="line">			a2 = (a2 ^ <span class="number">0x1B</span>) & <span class="number">0xFF</span></span><br><span class="line">		a1 = (a1 >> <span class="number">1</span>) & <span class="number">0xFF</span></span><br><span class="line">	<span class="keyword">return</span> v5</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	</span><br><span class="line">	s1 = <span class="string">'0123456789abcdefghijklmnopqrstuv'</span></span><br><span class="line">	s2 = <span class="string">'xyzdefghijklmnopqrstuv0123456789'</span> </span><br><span class="line">	sub_402070(s2[<span class="number">0</span>:<span class="number">16</span>])</span><br><span class="line">	<span class="comment">#sub_402070(s2[16:32])</span></span><br></pre></td></tr></tbody></table></figure></div>



<h2 id="大佬思路"><a href="#大佬思路" class="headerlink" title="大佬思路"></a>大佬思路</h2><ul>
<li><a href="https://bbs.pediy.com/thread-272812.htm" target="_blank" rel="noopener">dead.ash</a><ol>
<li>这位大佬的分析思路比较值得参考</li>
<li>首先单步一遍，理清大概的思路，把大部分的坑都踩一踩</li>
<li>梳理单步的逻辑，猜测校验流程</li>
<li>多次输入测试字符串，观察反馈结果</li>
<li>F5开始分析程序</li>
<li>依次分析算法，并分析出对应的逆算法</li>
</ol>
</li>
<li><a href="https://bbs.pediy.com/thread-272806.htm" target="_blank" rel="noopener">ThTsOd</a><ol>
<li>多处下断，梳理主要逻辑</li>
<li>找到关注点如长度判断与最后用于比较的<code>memcmp</code></li>
<li>IDA中使用Findcrypt进行算法侦测</li>
<li>分析与原本算法不同之处，即魔改的地方</li>
<li>针对魔改处，修改原本算法的解密算法</li>
</ol>
</li>
<li><a href="https://bbs.pediy.com/thread-272829.htm" target="_blank" rel="noopener">mb_mgodlfyn</a><ol>
<li>F5，梳理main函数逻辑</li>
<li>分析导致异常的暗装，进行对应的绕过（mb_mgodlfyn对绕过说明的更细）和patch（这部分<a href="https://bbs.pediy.com/thread-272772.htm" target="_blank" rel="noopener">sunfishi</a>贴出了patch后的代码，几处关键的patch都贴出了）</li>
<li>与标准的AES做对比进行分析</li>
<li>参考标准的AES解密算法进行修改并解密</li>
</ol>
</li>
</ul>
<p>还有部分大佬的就不贴出来了，整体的分析逻辑大差不差，其中<a href="https://bbs.pediy.com/thread-272774.htm" target="_blank" rel="noopener">wx_孤城</a>的做题技巧值得学习，他通过自旋的方式，成功解密了比较复杂的加密步骤；而<a href="https://bbs.pediy.com/thread-272772.htm" target="_blank" rel="noopener">sunfishi</a>则细心的patch了隐藏在异常处理中的核心逻辑，并且根据开源的AES项目导入了符号和结构体，看的也更加清晰；以上都是值得学习的思路和技巧。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ol>
<li><a href="https://bbs.pediy.com/thread-222556.htm" target="_blank" rel="noopener">看雪：Findcrypt安装说明</a></li>
<li><a href="https://github.com/polymorf/findcrypt-yara" target="_blank" rel="noopener">Github：Findcrypt官网</a></li>
<li><a href="https://www.jianshu.com/p/9ff977ded99d" target="_blank" rel="noopener">简书：看雪CTF签到题SEH异常处理</a></li>
<li><a href="https://blog.csdn.net/w1012747007/article/details/77131781" target="_blank" rel="noopener">CSDN：SEH的非常好的总结</a></li>
<li><a href="https://bbs.pediy.com/thread-272805.htm" target="_blank" rel="noopener">看雪：trackL分析文章</a></li>
<li><a href="https://bbs.pediy.com/thread-272829.htm" target="_blank" rel="noopener">看雪：mb_mgodlfyn分析文章</a></li>
<li><a href="https://github.com/lmshao/AES/" target="_blank" rel="noopener">Github：lmshao AES</a></li>
<li><a href="https://bbs.pediy.com/thread-269383.htm" target="_blank" rel="noopener">看雪：AES加密算法</a></li>
<li><a href="https://bbs.pediy.com/thread-253884.htm" target="_blank" rel="noopener">看雪：密码学基础：AES加密算法 </a></li>
<li><a href="https://blog.csdn.net/qq_28205153/article/details/55798628" target="_blank" rel="noopener">CSDN：AES加密算法的详细介绍与实现</a></li>
<li><a href="https://blog.csdn.net/shaosunrise/article/details/80219950" target="_blank" rel="noopener">CDSN：AES算法描述及C语言实现</a></li>
<li><a href="https://bbs.pediy.com/thread-272772.htm" target="_blank" rel="noopener">看雪：sunfishi分析文章</a></li>
<li><a href="https://bbs.pediy.com/thread-272774.htm" target="_blank" rel="noopener">看雪：wx_孤城</a></li>
<li><a href="https://bbs.pediy.com/thread-76870.htm" target="_blank" rel="noopener">看雪：IDA为什么产生 sp-analysis failed</a></li>
<li><a href="https://bbs.pediy.com/thread-140002.htm" target="_blank" rel="noopener">看雪：IDA sp-analysis failed 不能F5的 解决方案之(一)</a></li>
<li><a href="https://bbs.pediy.com/thread-158896.htm" target="_blank" rel="noopener">看雪：IDA sp-analysis failed 不能F5的 解决方案之(二) </a></li>
<li><a href="https://bbs.pediy.com/thread-267231.htm" target="_blank" rel="noopener">看雪：用DUMP的方式解决IDA F5失败</a></li>
<li><a href="https://bbs.pediy.com/thread-272787.htm#msg_header_h2_0" target="_blank" rel="noopener">看雪：堂前燕分析文章</a></li>
</ol>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">cataLoc</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://cata1oc.github.io/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/">http://cata1oc.github.io/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF    </a><a class="post-meta__tags" href="/tags/Windows%E9%80%86%E5%90%91/">Windows逆向    </a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/05/15/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%89%E9%A2%98/0x5C.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2022/05/24/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%83%E9%A2%98/"><img class="prev_cover lazyload" data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/05/24/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%83%E9%A2%98/0x5D.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Previous Post</div><div class="prev_info"><span>KCTF2022春季赛第七题</span></div></a></div><div class="next-post pull_right"><a href="/2022/05/13/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%BA%8C%E9%A2%98/"><img class="next_cover lazyload" data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/05/13/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%BA%8C%E9%A2%98/0x5B.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>KCTF2022春季赛第二题</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> Recommend</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2021/10/22/KCTF题库-异想天开/" title="KCTF题库：异想天开"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2021/10/22/KCTF%E9%A2%98%E5%BA%93-%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80/cover0x4B.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-10-22</div><div class="relatedPosts_title">KCTF题库：异想天开</div></div></a></div><div class="relatedPosts_item"><a href="/2022/05/13/KCTF2022春季赛第二题/" title="KCTF2022春季赛第二题"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/05/13/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%BA%8C%E9%A2%98/0x5B.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2022-05-13</div><div class="relatedPosts_title">KCTF2022春季赛第二题</div></div></a></div><div class="relatedPosts_item"><a href="/2022/05/24/KCTF2022春季赛第七题/" title="KCTF2022春季赛第七题"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/05/24/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B8%83%E9%A2%98/0x5D.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2022-05-24</div><div class="relatedPosts_title">KCTF2022春季赛第七题</div></div></a></div><div class="relatedPosts_item"><a href="/2022/06/02/KCTF2022春季赛第九题/" title="KCTF2022春季赛第九题"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/cata1oc/cata1oc.github.io/master/2022/06/02/KCTF2022%E6%98%A5%E5%AD%A3%E8%B5%9B%E7%AC%AC%E4%B9%9D%E9%A2%98/0x5E.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2022-06-02</div><div class="relatedPosts_title">KCTF2022春季赛第九题</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/12/一次简单的Hook-下/" title="一次简单的Hook（下）"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-12</div><div class="relatedPosts_title">一次简单的Hook（下）</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/10/一次简单的Hook-上/" title="一次简单的Hook（上）"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-10</div><div class="relatedPosts_title">一次简单的Hook（上）</div></div></a></div></div><div class="clear_both"></div></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2022 By cataLoc</div><div class="framework-info"><span>Driven </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="ribbon_piao" mobile="false" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>